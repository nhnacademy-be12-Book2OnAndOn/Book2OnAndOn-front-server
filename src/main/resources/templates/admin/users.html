<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>íšŒì› ê´€ë¦¬ - Admin</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>
<th:block
        th:replace="~{fragments/layout :: commonHeader(${nickname}, ${cartCount}, null, null, false)}"></th:block>

<div class="admin-container">
    <th:block th:replace="~{fragments/admin :: adminSidebar('users')}"></th:block>

    <main class="admin-content">
        <div class="admin-header">
            <h2>ğŸ‘¥ íšŒì› ê´€ë¦¬</h2>
            <span style="color: #666;">ì´ <span th:text="${page.totalElements}">0</span>ëª…</span>
        </div>

        <div style="color: green; margin-bottom: 15px; background: #e8f5e9; padding: 10px; border-radius: 4px;"
             th:if="${param.success}">
            âœ… ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
        </div>
        <div style="color: red; margin-bottom: 15px; background: #ffebee; padding: 10px; border-radius: 4px;"
             th:if="${param.error}">
            âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
        </div>

        <table class="admin-table">
            <thead>
            <tr>
                <th style="width: 50px;">ID</th>
                <th>ì•„ì´ë””</th>
                <th>ì´ë¦„</th>
                <th>ì´ë©”ì¼</th>
                <th>ë“±ê¸‰</th>
                <th>ìƒíƒœ</th>
                <th>ê¶Œí•œ</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user : ${users}">
                <td th:text="${user.userId}">1</td>

                <td>
                    <a style="font-weight: bold; color: #2d5016; text-decoration: none;"
                       th:href="@{/admin/users/{id}(id=${user.userId})}"
                       th:text="${user.userLoginId}">
                        testuser
                    </a>
                </td>

                <td th:text="${user.name}">í™ê¸¸ë™</td>
                <td th:text="${user.email}">email@test.com</td>
                <td><span class="badge" th:text="${user.gradeName}">BASIC</span></td>
                <td>
                    <span class="badge"
                          th:classappend="${user.status == 'ACTIVE' ? 'badge-active' :
                                           (user.status == 'CLOSED' ? 'badge-closed' : 'badge-dormant')}"
                          th:text="${user.status}">ACTIVE</span>
                </td>
                <td th:text="${user.role}">USER</td>
                <td>
                    <!-- ìˆ˜ì •ë¨: th:onclick â†’ th:attr -->
                    <button class="btn-small"
                            th:attr="onclick=|openEditModal('${user.userId}', '${user.role}', '${user.gradeName}', '${user.status}')|">
                        ìˆ˜ì •
                    </button>

                    <!-- ìˆ˜ì •ë¨: th:onclick â†’ th:attr -->
                    <button class="btn-small" style="color: #c62828; border-color: #c62828;"
                            th:attr="onclick=|deleteUser('${user.userId}')|">
                        ê°•í‡´
                    </button>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="pagination" style="margin-top: 20px; justify-content: center; display: flex; gap: 5px;">
            <a class="btn-small"
               style="text-decoration: none;"
               th:href="@{/admin/users(page=${page.number - 1})}" th:if="${!page.first}">&lt; ì´ì „</a>

            <span style="padding: 5px 10px; color: #666;"
                  th:text="${page.number + 1} + ' / ' + ${page.totalPages}">1 / 5</span>

            <a class="btn-small"
               style="text-decoration: none;"
               th:href="@{/admin/users(page=${page.number + 1})}" th:if="${!page.last}">ë‹¤ìŒ &gt;</a>
        </div>

    </main>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 style="margin-bottom: 20px;">íšŒì› ì •ë³´ ìˆ˜ì •</h3>
        <form id="editForm" method="post">
            <div class="form-row">
                <label>ê¶Œí•œ</label>
                <label for="editRole"></label>
                <select id="editRole" name="role">
                    <option value="USER">íšŒì›</option>
                    <option value="MEMBER_ADMIN">íšŒì› ê´€ë¦¬ì</option>
                    <option value="BOOK_ADMIN">ë„ì„œ ê´€ë¦¬ì</option>
                    <option value="ORDER_ADMIN">ì£¼ë¬¸ ê´€ë¦¬ì</option>
                    <option value="COUPON_ADMIN">ì¿ í° ê´€ë¦¬ì</option>
                    <option value="SUPER_ADMIN">ì´ê´€ë¦¬ì</option>
                </select>
            </div>
            <div class="form-row">
                <label>ë“±ê¸‰</label>
                <label for="editGrade"></label>
                <select id="editGrade" name="gradeName">
                    <option value="BASIC">BASIC</option>
                    <option value="ROYAL">ROYAL</option>
                    <option value="GOLD">GOLD</option>
                    <option value="PLATINUM">PLATINUM</option>
                </select>
            </div>
            <div class="form-row">
                <label>ìƒíƒœ</label>
                <label for="editStatus"></label>
                <select id="editStatus" name="status">
                    <option value="ACTIVE">ACTIVE</option>
                    <option value="DORMANT">DORMANT</option>
                    <option value="CLOSED">CLOSED</option>
                </select>
            </div>
            <button class="btn-primary" style="margin-top: 10px;" type="submit">ìˆ˜ì • ì™„ë£Œ</button>
        </form>
    </div>
</div>

<script>
    function openEditModal(userId, currentRole, currentGrade, currentStatus) {
        const modal = document.getElementById('editModal');
        const form = document.getElementById('editForm');

        form.action = '/admin/users/' + userId + '/update';

        document.getElementById('editRole').value = currentRole;
        document.getElementById('editGrade').value = currentGrade;
        document.getElementById('editStatus').value = currentStatus || 'ACTIVE';

        modal.style.display = 'block';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    window.onclick = function (event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
            modal.style.display = "none";
        }
    }

    function deleteUser(userId) {
        const reason = prompt("ê°•ì œ íƒˆí‡´ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:", "ìš´ì˜ ì •ì±… ìœ„ë°˜");
        if (reason) {
            const form = document.createElement('form');
            form.method = 'post';
            form.action = '/admin/users/' + userId + '/delete';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'reason';
            input.value = reason;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>

</body>
</html>

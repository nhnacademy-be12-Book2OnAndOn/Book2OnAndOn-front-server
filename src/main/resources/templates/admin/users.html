<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>íšŒì› ê´€ë¦¬ - Admin</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>
<th:block
        th:replace="~{fragments/layout :: commonHeader(${user} ?: ${session.user}, ${cartCount}, null, null, false)}"></th:block>

<div class="admin-container">
    <th:block th:replace="~{fragments/admin :: adminSidebar('users')}"></th:block>

    <main class="admin-content">
        <div class="admin-header">
            <h2>ğŸ‘¥ íšŒì› ê´€ë¦¬</h2>
            <span style="color: #666;">ì´ <span th:text="${page != null ? page.totalElements : 0}">0</span>ëª…</span>
        </div>

        <div style="color: green; margin-bottom: 15px; background: #e8f5e9; padding: 10px; border-radius: 4px;"
             th:if="${param.success}">
            âœ… ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
        </div>
        <div style="color: red; margin-bottom: 15px; background: #ffebee; padding: 10px; border-radius: 4px;"
             th:if="${param.error}">
            âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
        </div>

        <div th:if="${page != null}">
        <table class="admin-table">
            <thead>
            <tr>
                <th class="table-col-id" style="width: 50px;">ID</th>
                <th class="table-col-name">ì•„ì´ë””</th>
                <th class="table-col-name">ì´ë¦„</th>
                <th class="table-col-email">ì´ë©”ì¼</th>
                <th>ê°€ì… ê²½ë¡œ</th>
                <th>ë“±ê¸‰</th>
                <th>ìƒíƒœ</th>
                <th>ê¶Œí•œ</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user : ${users}">
                <td class="table-col-id" th:text="${user.userId}">1</td>

                <td>
                    <a style="font-weight: bold; color: #2d5016; text-decoration: none;"
                       th:href="@{/admin/users/{id}(id=${user.userId})}"
                       th:text="${user.userLoginId}" class="user-text">
                        testuser
                    </a>
                </td>

                <td class="table-col-name user-text" th:text="${user.name}">í™ê¸¸ë™</td>
                <td class="table-col-email text-break user-text" th:text="${user.email}">email@test.com</td>

                <td>
                    <span class="badge"
                          style="background-color: #f0f0f0; color: #333; border: 1px solid #ccc;"
                          th:text="${user.provider}">LOCAL</span>
                </td>

                <td><span class="badge" th:text="${user.gradeName}">BASIC</span></td>
                <td>
                    <span class="badge"
                          th:classappend="${user.status == 'ACTIVE' ? 'badge-active' :
                                           (user.status == 'CLOSED' ? 'badge-closed' : 'badge-dormant')}"
                          th:text="${user.status}">ACTIVE</span>
                </td>
                <td th:text="${user.role}">USER</td>
                <td class="table-actions">
                    <button class="btn-ghost-link dense"
                            th:if="${user.role != 'SUPER_ADMIN'}"
                            th:attr="onclick=|openEditModal('${user.userId}', '${user.role}', '${user.gradeName}', '${user.status}')|">
                        ìˆ˜ì •
                    </button>
                    <button class="btn-danger dense"
                            th:if="${user.role != 'SUPER_ADMIN'}"
                            th:attr="onclick=|deleteUser('${user.userId}')|">
                        ê°•í‡´
                    </button>
                    <span th:if="${user.role == 'SUPER_ADMIN'}"
                          class="badge"
                          style="background-color: #e0e0e0; color: #888; font-size: 0.85rem; padding: 6px 10px;">
                            ê´€ë¦¬ ë¶ˆê°€
                    </span>
                </td>
            </tr>
            </tbody>
        </table>
        </div>

        <div class="muted" th:if="${page == null}" style="padding: 1rem 0;">íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div>

        <div class="pagination" th:if="${page != null and page.totalPages > 0}">
            <a class="page-link"
               th:if="${!page.first}"
               th:href="@{/admin/users(page=${page.number - 1})}">&lt;</a>

            <th:block th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}">
                <a class="page-link"
                   th:classappend="${i == page.number} ? 'active'"
                   th:href="@{/admin/users(page=${i})}"
                   th:text="${i + 1}">1</a>
            </th:block>

            <a class="page-link"
               th:if="${!page.last}"
               th:href="@{/admin/users(page=${page.number + 1})}">&gt;</a>
        </div>

    </main>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-title">
            <h3>íšŒì› ì •ë³´ ìˆ˜ì •</h3>
            <p class="muted">ê¶Œí•œÂ·ë“±ê¸‰Â·ìƒíƒœë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.</p>
        </div>
        <form id="editForm" method="post" class="form-grid">
            <div class="form-field">
                <label for="editRole">ê¶Œí•œ</label>
                <select id="editRole" name="role" class="form-control">
                    <option value="USER">íšŒì›</option>
                    <option value="MEMBER_ADMIN">íšŒì› ê´€ë¦¬ì</option>
                    <option value="BOOK_ADMIN">ë„ì„œ ê´€ë¦¬ì</option>
                    <option value="ORDER_ADMIN">ì£¼ë¬¸ ê´€ë¦¬ì</option>
                    <option value="COUPON_ADMIN">ì¿ í° ê´€ë¦¬ì</option>
                    <option value="SUPER_ADMIN">ì´ê´€ë¦¬ì</option>
                </select>
            </div>
            <div class="form-field">
                <label for="editGrade">ë“±ê¸‰</label>
                <select id="editGrade" name="gradeName" class="form-control">
                    <option value="BASIC">BASIC</option>
                    <option value="ROYAL">ROYAL</option>
                    <option value="GOLD">GOLD</option>
                    <option value="PLATINUM">PLATINUM</option>
                </select>
            </div>
            <div class="form-field">
                <label for="editStatus">ìƒíƒœ</label>
                <select id="editStatus" name="status" class="form-control">
                    <option value="ACTIVE">ACTIVE</option>
                    <option value="DORMANT">DORMANT</option>
                    <option value="CLOSED">CLOSED</option>
                </select>
            </div>
            <div class="modal-actions" style="grid-column: 1 / -1; padding-top: 6px;">
                <button type="button" class="btn-ghost" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn-primary" type="submit">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </form>
    </div>
</div>

<script>
    // ... ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ìƒëµ (ë³€ê²½ ì—†ìŒ) ...
    // ê¸´ í…ìŠ¤íŠ¸ë§Œ ì¶•ì†Œ ì ìš©
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.user-text').forEach(el => {
            const len = (el.textContent || '').trim().length;
            if (len > 22) {
                el.classList.add('compact-text');
            }
        });
    });

    function openEditModal(userId, currentRole, currentGrade, currentStatus) {
        const modal = document.getElementById('editModal');
        const form = document.getElementById('editForm');

        form.action = '/admin/users/' + userId + '/update';

        document.getElementById('editRole').value = currentRole;
        document.getElementById('editGrade').value = currentGrade;
        document.getElementById('editStatus').value = currentStatus || 'ACTIVE';

        modal.style.display = 'block';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    window.onclick = function (event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
            modal.style.display = "none";
        }
    }

    function deleteUser(userId) {
        const reason = prompt("ê°•ì œ íƒˆí‡´ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:", "ìš´ì˜ ì •ì±… ìœ„ë°˜");
        if (reason) {
            const form = document.createElement('form');
            form.method = 'post';
            form.action = '/admin/users/' + userId + '/delete';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'reason';
            input.value = reason;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>

<th:block th:replace="~{fragments/layout :: commonFooter}"></th:block>

</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì - ë°°ì†¡ ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* ê´€ë¦¬ì ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .admin-container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }

        /* í—¤ë” */
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #333;
        }
        .page-title h2 { margin: 0; font-size: 1.5rem; color: #333; }

        /* í•„í„° íˆ´ë°” */
        .filter-toolbar {
            background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd;
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
        }
        .filter-label { font-weight: bold; color: #555; }
        .filter-select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; min-width: 150px; }
        .btn-search { background: #333; color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-reset { text-decoration: none; color: #666; font-size: 0.9rem; margin-left: auto; padding: 8px; }

        /* í…Œì´ë¸” */
        .table-container { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #f0f0f0; font-size: 0.95rem; }
        th { background: #f8f9fa; font-weight: 600; color: #555; text-transform: uppercase; font-size: 0.85rem; }
        tbody tr:hover { background-color: #f1f8e9; }

        /* ìƒíƒœ ë°°ì§€ */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; display: inline-block; }
        .status-PREPARING { background: #fff3e0; color: #e65100; } /* ë°°ì†¡ì¤€ë¹„ì¤‘ */
        .status-SHIPPING { background: #e3f2fd; color: #1565c0; }  /* ë°°ì†¡ì¤‘ */
        .status-DELIVERED { background: #e8f5e9; color: #2e7d32; } /* ë°°ì†¡ì™„ë£Œ */
        .status-PENDING { background: #f5f5f5; color: #616161; }   /* ì£¼ë¬¸ëŒ€ê¸°/ê²°ì œì™„ë£Œ */

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-action {
            padding: 6px 12px; border: 1px solid #ddd; background: white;
            border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 600;
            transition: all 0.2s;
        }
        .btn-register { color: #2d5016; border-color: #2d5016; }
        .btn-register:hover { background: #2d5016; color: white; }
        .btn-update { color: #555; border-color: #aaa; }
        .btn-update:hover { background: #f5f5f5; color: #333; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 12px; width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-header h3 { margin: 0 0 1.5rem 0; color: #333; border-bottom: 2px solid #2d5016; padding-bottom: 10px; display: inline-block; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 2rem; }
        .btn-modal { padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-close { background: #f1f3f5; border: 1px solid #ddd; color: #333; }
        .btn-submit { background: #2d5016; border: none; color: white; }

        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 2rem; }
        .page-link { padding: 8px 12px; border: 1px solid #ddd; background: white; color: #333; text-decoration: none; border-radius: 4px; }
        .page-link.active { background-color: #2d5016; color: white; border-color: #2d5016; }
    </style>
</head>
<body>

<div class="admin-container">

    <div class="page-header">
        <div class="page-title">
            <h2>ğŸ“¦ ë°°ì†¡ ê´€ë¦¬</h2>
        </div>
    </div>

    <form action="/admin/deliveries" method="get" class="filter-toolbar">
        <span class="filter-label">ì£¼ë¬¸ ìƒíƒœ:</span>
        <select name="status" class="filter-select">
            <option value="">ì „ì²´ ë³´ê¸°</option>
            <option th:each="st : ${orderStatuses}"
                    th:value="${st}"
                    th:text="${st.description != null ? st.description : st.name()}"
                    th:selected="${st == searchStatus}">
            </option>
        </select>
        <button type="submit" class="btn-search">ê²€ìƒ‰</button>
        <a href="/admin/deliveries" class="btn-reset">â†º ì´ˆê¸°í™”</a>
    </form>

    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th>ë°°ì†¡ ID</th>
                <th>ì£¼ë¬¸ ë²ˆí˜¸</th>
                <th>íƒë°°ì‚¬</th>
                <th>ìš´ì†¡ì¥ ë²ˆí˜¸</th>
                <th>ë°°ì†¡ ì‹œì‘ì¼</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="delivery : ${deliveries}">
                <td th:text="${delivery.deliveryId}"></td>
                <td th:text="${delivery.orderId}"></td>
                <td th:text="${delivery.deliveryCompany != null ? delivery.deliveryCompany : '-'}"></td>
                <td th:text="${delivery.waybill != null ? delivery.waybill : '-'}"></td>
                <td th:text="${delivery.deliveryStartedAt != null ? #temporals.format(delivery.deliveryStartedAt, 'yyyy-MM-dd HH:mm') : '-'}"></td>

                <td>
                    <button th:if="${delivery.waybill == null}"
                            class="btn-action btn-register"
                            th:onclick="openModal('REGISTER', [[${delivery.deliveryId}]], '', '')">
                        ğŸšš ìš´ì†¡ì¥ ë“±ë¡
                    </button>

                    <button th:if="${delivery.waybill != null}"
                            class="btn-action btn-update"
                            th:onclick="openModal('UPDATE', [[${delivery.deliveryId}]], [[${delivery.deliveryCompany}]], [[${delivery.waybill}]])">
                        âœï¸ ì •ë³´ ìˆ˜ì •
                    </button>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(deliveries)}">
                <td colspan="6" style="text-align: center; padding: 3rem; color: #999;">
                    ì¡°íšŒëœ ë°°ì†¡ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination" th:if="${totalPages > 0}">
        <a th:if="${currentPage > 0}"
           th:href="@{/admin/deliveries(page=${currentPage - 1}, status=${searchStatus})}"
           class="page-link">&lt;</a>

        <th:block th:each="i : ${#numbers.sequence(startPage, endPage)}">
            <a th:href="@{/admin/deliveries(page=${i}, status=${searchStatus})}"
               th:text="${i + 1}"
               class="page-link"
               th:classappend="${i == currentPage} ? 'active'">1</a>
        </th:block>

        <a th:if="${currentPage < totalPages - 1}"
           th:href="@{/admin/deliveries(page=${currentPage + 1}, status=${searchStatus})}"
           class="page-link">&gt;</a>
    </div>

</div>

<div id="waybillModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">ìš´ì†¡ì¥ ë“±ë¡</h3>
        </div>

        <form id="waybillForm" method="post">
            <div class="form-group">
                <label for="deliveryCompany">íƒë°°ì‚¬</label>
                <select name="deliveryCompany" id="deliveryCompany" class="form-control" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option th:each="comp : ${deliveryCompanies}"
                            th:value="${comp.name}"
                            th:text="${comp.name}">CJëŒ€í•œí†µìš´</option>
                </select>
            </div>

            <div class="form-group">
                <label for="waybill">ìš´ì†¡ì¥ ë²ˆí˜¸</label>
                <input type="text" name="waybill" id="waybill" class="form-control"
                       placeholder="ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš”" required pattern="[0-9]+">
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-modal btn-close" onclick="closeModal()">ì·¨ì†Œ</button>
                <button type="submit" class="btn-modal btn-submit">ì €ì¥</button>
            </div>
        </form>
    </div>
</div>

<script>
    const modal = document.getElementById('waybillModal');
    const form = document.getElementById('waybillForm');
    const title = document.getElementById('modalTitle');
    const companySelect = document.getElementById('deliveryCompany');
    const waybillInput = document.getElementById('waybill');

    /**
     * ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
     * mode: 'REGISTER' (ë“±ë¡) ë˜ëŠ” 'UPDATE' (ìˆ˜ì •)
     */
    function openModal(mode, id, currentCompany, currentWaybill) {
        modal.style.display = 'flex';

        if (mode === 'REGISTER') {
            title.innerText = 'ìš´ì†¡ì¥ ë“±ë¡ (ë°°ì†¡ ì‹œì‘)';
            // Controller: @PostMapping("/deliveries/{id}/waybill")
            form.action = `/admin/deliveries/${id}/waybill`;

            // ì´ˆê¸°í™”
            companySelect.value = '';
            waybillInput.value = '';

        } else {
            title.innerText = 'âœï¸ ë°°ì†¡ ì •ë³´ ìˆ˜ì •';
            // Controller: @PostMapping("/deliveries/{id}/info")
            form.action = `/admin/deliveries/${id}/info`;

            // ê¸°ì¡´ ê°’ ì±„ìš°ê¸°
            if (currentCompany) companySelect.value = currentCompany;
            if (currentWaybill) waybillInput.value = currentWaybill;
        }

        setTimeout(() => waybillInput.focus(), 100);
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        if (event.target == modal) closeModal();
    }
</script>

</body>
</html>
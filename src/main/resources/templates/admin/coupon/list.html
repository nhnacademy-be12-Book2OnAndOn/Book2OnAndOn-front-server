<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì - ì¿ í° ë°œê¸‰ ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .admin-container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }

        /* íƒ­ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ê³¼ ë™ì¼) */
        .status-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab-item { padding: 10px 20px; text-decoration: none; color: #666; border-radius: 8px 8px 0 0; }
        .tab-item.active { background: white; color: #2d5016; border: 1px solid #ddd; border-bottom: 1px solid white; margin-bottom: -1px; font-weight: bold;}

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #555; }

        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; }
        .badge-active { background: #e8f5e9; color: #2e7d32; }
        .badge-deactive { background: #ffebee; color: #c62828; }

        /* ìˆ˜ì • ë²„íŠ¼ */
        .btn-edit {
            padding: 5px 10px; background: white; border: 1px solid #2d5016;
            color: #2d5016; border-radius: 4px; cursor: pointer; transition: 0.2s;
        }
        .btn-edit:hover { background: #2d5016; color: white; }

        /* ===== ëª¨ë‹¬ (ë¸”ë¼ì¸ë“œ íš¨ê³¼) ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª… ê²€ì • ë°°ê²½ */
            z-index: 1000;
            display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
            justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease; /* í˜ì´ë“œ íš¨ê³¼ */
        }

        .modal-overlay.show { display: flex; opacity: 1; }

        .modal-box {
            background: white; width: 400px; padding: 25px;
            border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: translateY(-20px); transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-box { transform: translateY(0); }

        .form-row { margin-top: 15px; display: flex; gap: 10px; align-items: center; }
        .modal-btns { margin-top: 25px; text-align: right; }
        .modal-btns button { padding: 8px 15px; border-radius: 4px; cursor: pointer; border: none;}
        .btn-save { background: #2d5016; color: white; }
        .btn-close { background: #eee; color: #333; margin-right: 5px; }
    </style>
</head>
<body>

<div class="admin-container">
    <h2>ì¿ í° ë°œê¸‰ ê´€ë¦¬</h2>

    <div class="status-tabs">
        <a th:href="@{/admin/coupons}" class="tab-item"
           th:classappend="${searchStatus == null} ? 'active'">ì „ì²´</a>
        <a th:href="@{/admin/coupons(status='ACTIVE')}" class="tab-item"
           th:classappend="${searchStatus == 'ACTIVE'} ? 'active'">í™œì„±</a>
        <a th:href="@{/admin/coupons(status='DEACTIVE')}" class="tab-item"
           th:classappend="${searchStatus == 'DEACTIVE'} ? 'active'">ë¹„í™œì„±</a>
    </div>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>ì¿ í°ëª…</th>
            <th>í˜œíƒ</th>
            <th>ìœ íš¨ê¸°ê°„</th>
            <th>ìƒíƒœ</th>
            <th>ì”ì—¬ ìˆ˜ëŸ‰</th>
            <th>ê´€ë¦¬</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="coupon : ${coupons}">
            <td th:text="${coupon.couponId}">1</td>
            <td>
                <span th:text="${coupon.couponName}" style="font-weight: bold;"></span>
                <br><span style="font-size: 0.8rem; color: #888;" th:text="${coupon.discountDescription}"></span>
            </td>

            <td th:text="${coupon.discountDescription}">5,000ì› í• ì¸</td>

            <td>
                    <span th:if="${coupon.endDate != null}"
                          th:text="|~ ${coupon.endDate} ê¹Œì§€|"
                          th:style="${coupon.endDate.isBefore(today) ? 'color: red;' : ''}"></span>

                <span th:if="${coupon.durationDays != null}"
                      th:text="|ë°œê¸‰ í›„ ${coupon.durationDays}ì¼|"></span>
            </td>

            <td>
                <span th:if="${coupon.status.name() == 'ACTIVE'}" class="badge badge-active">í™œì„±</span>
                <span th:if="${coupon.status.name() != 'ACTIVE'}" class="badge badge-deactive">ë¹„í™œì„±</span>
            </td>

            <td style="font-weight: bold; color: #007bff;">
                <span th:if="${coupon.couponRemainingQuantity == null}">â™¾ï¸ ë¬´ì œí•œ</span>
                <span th:if="${coupon.couponRemainingQuantity != null}"
                      th:text="${#numbers.formatInteger(coupon.couponRemainingQuantity, 0, 'COMMA')} + 'ê°œ'"></span>
            </td>

            <td>
                <button type="button" class="btn-edit"
                        th:if="${coupon.status.name() == 'ACTIVE' and (coupon.endDate == null or !coupon.endDate.isBefore(today))}"
                        th:onclick="openQuantityModal([[${coupon.couponId}]], [[${coupon.couponRemainingQuantity}]])">
                    ìˆ˜ëŸ‰ ìˆ˜ì •
                </button>

                <span th:if="${coupon.endDate != null and coupon.endDate.isBefore(today)}"
                      style="font-size: 0.8rem; color: #e53935; font-weight: bold;">(ë§Œë£Œë¨)</span>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div id="quantityModal" class="modal-overlay">
    <div class="modal-box">
        <h3>ğŸ“¦ ì¬ê³  ìˆ˜ëŸ‰ ìˆ˜ì •</h3>
        <p style="color: #666; font-size: 0.9rem;">í˜„ì¬ ë°œê¸‰ ê°€ëŠ¥í•œ ì¿ í° ìˆ˜ëŸ‰ì„ ë³€ê²½í•©ë‹ˆë‹¤.</p>

        <form id="quantityForm" method="post">
            <div class="form-row">
                <input type="number" id="modalQuantity" name="quantity" class="form-control" placeholder="ìˆ˜ëŸ‰ ì…ë ¥" style="width: 100%; padding: 10px; border: 1px solid #ddd;">

                <label style="white-space: nowrap; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="modalUnlimited" onchange="toggleModalInput()"> ë¬´ì œí•œ
                </label>
            </div>

            <div class="modal-btns">
                <button type="button" class="btn-close" onclick="closeQuantityModal()">ì·¨ì†Œ</button>
                <button type="submit" class="btn-save">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </form>
    </div>
</div>

<script>
    const modal = document.getElementById('quantityModal');
    const form = document.getElementById('quantityForm');
    const quantityInput = document.getElementById('modalQuantity');
    const unlimitedCheck = document.getElementById('modalUnlimited');

    // ëª¨ë‹¬ ì—´ê¸° (ì¿ í° IDì™€ í˜„ì¬ ìˆ˜ëŸ‰ì„ ë°›ìŒ)
    function openQuantityModal(couponId, currentQty) {
        // í¼ Action URL ì—…ë°ì´íŠ¸ (/admin/coupons/{id}/update-quantity)
        form.action = `/admin/coupons/${couponId}/update-quantity`;

        // ê¸°ì¡´ ê°’ ì„¸íŒ…
        if (currentQty === null) {
            unlimitedCheck.checked = true;
            quantityInput.value = '';
            quantityInput.disabled = true;
        } else {
            unlimitedCheck.checked = false;
            quantityInput.value = currentQty;
            quantityInput.disabled = false;
        }

        modal.classList.add('show'); // ë³´ì´ê²Œ í•˜ê¸°
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeQuantityModal() {
        modal.classList.remove('show');
    }

    // ë¬´ì œí•œ ì²´í¬ í† ê¸€ ë¡œì§
    function toggleModalInput() {
        if (unlimitedCheck.checked) {
            quantityInput.value = '';
            quantityInput.disabled = true;
            quantityInput.placeholder = "ë¬´ì œí•œ";
        } else {
            quantityInput.disabled = false;
            quantityInput.placeholder = "ìˆ˜ëŸ‰ ì…ë ¥";
            quantityInput.focus();
        }
    }

    // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        if (event.target == modal) {
            closeQuantityModal();
        }
    }
</script>

</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>관리자 - 쿠폰 정책 등록/수정</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <style>
        /* 체크박스 레이블 스타일 */
        .remove-option {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            color: #666;
            cursor: pointer;
            white-space: nowrap;
        }
    </style>
</head>

<th:block
        th:replace="~{fragments/layout :: commonHeader(${user} ?: ${session.user}, ${cartCount}, null, null, false)}"></th:block>
<body>

<div class="admin-container">
    <th:block th:replace="~{fragments/admin :: adminSidebar('couponpolicies')}"></th:block>

    <main class="admin-content">
        <div class="admin-header">
            <div>
                <p class="eyebrow">쿠폰 정책</p>
                <h2 th:text="${pageTitle}">쿠폰 정책 등록</h2>
            </div>
            <a class="btn-ghost" th:href="@{/admin/policies}">← 목록으로</a>
        </div>

        <section class="admin-detail-card form-section">
            <h4>기본 정보</h4>
            <form method="post"
                  th:action="${policy.couponPolicyId == null ? '/admin/policies/create' : '/admin/policies/update/' + policy.couponPolicyId}" th:object="${policy}">

                <div class="form-field">
                    <label for="couponPolicyName">정책 이름</label>
                    <input class="form-control" id="couponPolicyName" placeholder="예: 신규 회원 웰컴 쿠폰" required
                           th:field="*{couponPolicyName}" type="text">
                </div>

                <div class="form-grid">
                    <div class="form-field">
                        <label for="couponPolicyType">쿠폰 타입</label>
                        <select class="form-control" id="couponPolicyType" th:field="*{couponPolicyType}">
                            <option th:each="type : ${policyTypes}" th:text="${type}" th:value="${type}"></option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="couponPolicyDiscountType">할인 방식</label>
                        <select class="form-control" id="couponPolicyDiscountType"
                                th:field="*{couponPolicyDiscountType}">
                            <option th:each="dtype : ${discountTypes}" th:text="${dtype}" th:value="${dtype}"></option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="couponDiscountValue">할인값 (원/%)</label>
                        <input class="form-control" id="couponDiscountValue" required
                               th:field="*{couponDiscountValue}" type="number">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-field">
                        <label for="minPrice">최소 주문 금액</label>
                        <input class="form-control" id="minPrice" th:field="*{minPrice}" type="number" value="0">
                    </div>
                    <div class="form-field">
                        <label for="maxPrice">최대 할인 금액 (정률 할인 시)</label>
                        <div class="inline-control">
                            <input class="form-control" id="maxPrice" th:field="*{maxPrice}" type="number">
                            <input id="removeMaxPriceFlag" th:field="*{removeMaxPrice}" type="hidden">
                            <button class="remove-btn" data-flag="removeMaxPriceFlag" data-target="#maxPrice"
                                    type="button">제거
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-section" style="margin-top:1rem;">
                    <h4>유효 기간 설정</h4>
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="durationDays">발급 후 유효 일수</label>
                            <div class="inline-control">
                                <input class="form-control" id="durationDays" placeholder="예: 30" th:field="*{durationDays}"
                                       type="number">
                                <input id="removeDurationDaysFlag" th:field="*{removeDurationDays}" type="hidden">
                                <button class="remove-btn" data-flag="removeDurationDaysFlag" data-target="#durationDays"
                                        type="button">제거
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label>고정 기간 (시작 ~ 종료)</label>
                            <div class="inline-control" style="flex-wrap: wrap;">
                                <input class="form-control" id="fixedStartDate" style="flex:1;" th:field="*{fixedStartDate}"
                                       type="date">
                                <input class="form-control" id="fixedEndDate" style="flex:1;" th:field="*{fixedEndDate}"
                                       type="date">
                                <input id="removeFixedDateFlag" th:field="*{removeFixedDate}" type="hidden">
                                <button class="remove-btn" data-flag="removeFixedDateFlag" data-target="#fixedStartDate,#fixedEndDate"
                                        type="button">제거
                                </button>
                            </div>
                        </div>
                    </div>
                    <p class="field-note">기간을 동시에 입력하면 고정 기간을 우선 적용합니다.</p>
                </div>

                <div class="form-field" style="margin-top:1rem;">
                    <label for="targetBookIds">적용 대상 도서 ID (쉼표로 구분)</label>
                    <div class="inline-control">
                        <input class="form-control" id="targetBookIds" placeholder="예: 101, 102, 103" th:field="*{targetBookIds}"
                               type="text">
                        <input id="removeTargetBookFlag" th:field="*{removeTargetBook}" type="hidden">
                        <button class="remove-btn" data-flag="removeTargetBookFlag" data-target="#targetBookIds"
                                type="button">제거
                        </button>
                    </div>
                </div>

                <div class="form-field">
                    <label>적용 대상 카테고리</label>
                    <div class="checkbox-box">
                        <div class="muted" th:if="${#lists.isEmpty(categoryList)}">
                            등록된 카테고리가 없습니다.
                        </div>
                        <div style="margin-bottom: 5px;" th:each="cat : ${categoryList}">
                            <input th:field="*{targetCategoryIds}"
                                   th:id="${'cat_' + cat.id}"
                                   th:value="${cat.id}"
                                   type="checkbox">
                            <label th:for="${'cat_' + cat.id}" th:text="${cat.name}">카테고리</label>
                        </div>
                    </div>
                    <input id="removeTargetCategoryFlag" th:field="*{removeTargetCategory}" type="hidden">
                    <button class="remove-btn" data-flag="removeTargetCategoryFlag" data-target=".checkbox-box input[type='checkbox']"
                            style="margin-top:5px;" type="button">전체 제거
                    </button>
                </div>

                <div class="form-field" style="margin-top:1rem;" th:if="${policy.couponPolicyId != null}">
                    <label for="couponPolicyStatus">정책 상태</label>
                    <select class="form-control" id="couponPolicyStatus" th:field="*{couponPolicyStatus}">
                        <option th:each="status : ${statuses}"
                                th:text="${status}"
                                th:value="${status}"></option>
                    </select>
                </div>

                <div class="modal-actions" style="margin-top: 2rem; display:flex; justify-content:flex-end; gap:10px;">
                    <a class="btn-ghost" th:href="@{/admin/policies}">취소</a>
                    <button class="btn-primary" type="submit">저장하기</button>
                </div>
            </form>
        </section>
    </main>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const durationInput = document.getElementById('durationDays');
        const startInput = document.getElementById('fixedStartDate');
        const endInput = document.getElementById('fixedEndDate');
        const removeDuration = document.getElementById('removeDurationDaysFlag');
        const removeFixed = document.getElementById('removeFixedDateFlag');

        function syncDurationFields() {
            const hasDuration = durationInput && durationInput.value.trim() !== '' && !durationInput.disabled;
            const hasFixed = removeFixed?.value !== 'true' && ((startInput && startInput.value) || (endInput && endInput.value));

            if (hasDuration) {
                if (startInput) {
                    startInput.value = '';
                    startInput.disabled = true;
                }
                if (endInput) {
                    endInput.value = '';
                    endInput.disabled = true;
                }
                if (removeFixed) {
                    removeFixed.value = 'true';
                }
            } else if (removeFixed?.value !== 'true') {
                if (startInput) startInput.disabled = false;
                if (endInput) endInput.disabled = false;
            }

            if (hasFixed) {
                if (durationInput) {
                    durationInput.value = '';
                    durationInput.disabled = true;
                }
                if (removeDuration) {
                    removeDuration.value = 'true';
                }
            } else if (removeDuration?.value !== 'true' && durationInput) {
                durationInput.disabled = false;
            }

            ensureOneActive();
        }

        function ensureOneActive() {
            const durationEmpty = durationInput && durationInput.value.trim() === '';
            const fixedEmpty = (!startInput || startInput.value === '') && (!endInput || endInput.value === '');
            const durationBlocked = durationInput && durationInput.disabled;
            const fixedBlocked = (!startInput || startInput.disabled) && (!endInput || endInput.disabled);
            const durationRemoved = removeDuration && removeDuration.value === 'true';
            const fixedRemoved = removeFixed && removeFixed.value === 'true';

            // 둘 다 제거/비활성/미입력 상태라면 유효일수를 우선 활성화
            if ((durationBlocked || durationRemoved || durationEmpty) && (fixedBlocked || fixedRemoved || fixedEmpty)) {
                if (removeDuration) removeDuration.value = 'false';
                if (durationInput) {
                    durationInput.disabled = false;
                    durationInput.style.backgroundColor = "";
                }
            }
        }

        if (durationInput) {
            durationInput.addEventListener('input', syncDurationFields);
        }
        if (startInput) {
            startInput.addEventListener('input', syncDurationFields);
        }
        if (endInput) {
            endInput.addEventListener('input', syncDurationFields);
        }

        // 제거 버튼: 대상 입력 초기화/비활성 + 플래그 true
        document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const flagId = btn.dataset.flag;
                const targets = btn.dataset.target?.split(',') || [];
                if (flagId) {
                    const flag = document.getElementById(flagId);
                    if (flag) flag.value = 'true';
                }
                targets.forEach(sel => {
                    const trimmed = sel.trim();
                    if (!trimmed) return;
                    document.querySelectorAll(trimmed).forEach(el => {
                        if (el.tagName === 'INPUT' && el.type === 'checkbox') {
                            el.checked = false;
                        } else {
                            el.value = '';
                        }
                        el.disabled = true;
                        el.style.backgroundColor = "#e9ecef";
                    });
                });
                syncDurationFields();
            });
        });

        // 입력이 다시 작성되면 제거 플래그 해제
        const flagMap = [
            {input: durationInput, flagId: 'removeDurationDaysFlag'},
            {input: startInput, flagId: 'removeFixedDateFlag'},
            {input: endInput, flagId: 'removeFixedDateFlag'},
            {input: document.getElementById('maxPrice'), flagId: 'removeMaxPriceFlag'},
            {input: document.getElementById('targetBookIds'), flagId: 'removeTargetBookFlag'},
        ];
        flagMap.forEach(({input, flagId}) => {
            if (!input) return;
            input.addEventListener('input', () => {
                const flag = document.getElementById(flagId);
                if (flag) {
                    flag.value = 'false';
                    input.disabled = false;
                    input.style.backgroundColor = "";
                }
                syncDurationFields();
            });
        });

        const categoryCheckboxes = document.querySelectorAll(".checkbox-box input[type='checkbox']");
        categoryCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const flag = document.getElementById('removeTargetCategoryFlag');
                if (flag) flag.value = 'false';
            });
        });

        syncDurationFields();

        // 제출 시 하나는 반드시 값이 있도록 검증
        const formEl = document.querySelector('form');
        if (formEl) {
            formEl.addEventListener('submit', (e) => {
                const durationVal = durationInput?.disabled ? '' : (durationInput?.value || '').trim();
                const fixedVal = (startInput && !startInput.disabled ? startInput.value : '') ||
                    (endInput && !endInput.disabled ? endInput.value : '');
                if (!durationVal && !fixedVal) {
                    e.preventDefault();
                    alert('유효 기간을 하나 이상 입력하세요. (발급 후 일수 또는 고정 기간)');
                }
            });
        }
    });
</script>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì - ì¿ í° ì •ì±… ë“±ë¡/ìˆ˜ì •</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/admin-coupon-policy.css}">
</head>

<th:block th:replace="~{fragments/layout :: commonHeader(${user} ?: (${session.user} ?: null), ${cartCount}, null, null, false)}"></th:block>

<body>
<div class="admin-container">
    <th:block th:replace="~{fragments/admin :: adminSidebar('couponpolicies')}"></th:block>

    <main class="admin-content">
        <div class="admin-header">
            <div>
                <p class="eyebrow">ì¿ í° ì •ì±…</p>
                <h2 th:text="${pageTitle}">ì¿ í° ì •ì±… ë“±ë¡</h2>
            </div>
            <a class="btn-ghost" th:href="@{/admin/policies}">â† ëª©ë¡ìœ¼ë¡œ</a>
        </div>

        <section class="admin-detail-card form-section">
            <h4>ê¸°ë³¸ ì •ë³´</h4>
            <form method="post" id="policyForm"
                  th:action="${policy.couponPolicyId == null ? '/admin/policies/create' : '/admin/policies/update/' + policy.couponPolicyId}"
                  th:object="${policy}">

                <div class="form-field">
                    <label for="couponPolicyName">ì •ì±… ì´ë¦„</label>
                    <input class="form-control" id="couponPolicyName" placeholder="ì˜ˆ: ì‹ ê·œ íšŒì› ì›°ì»´ ì¿ í°" required th:field="*{couponPolicyName}" type="text">
                </div>

                <div class="form-grid">
                    <div class="form-field">
                        <label for="couponPolicyType">ì¿ í° íƒ€ì…</label>
                        <select class="form-control" id="couponPolicyType" th:field="*{couponPolicyType}">
                            <option th:each="type : ${policyTypes}" th:text="${type}" th:value="${type}"></option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="couponPolicyDiscountType">í• ì¸ ë°©ì‹</label>
                        <select class="form-control" id="couponPolicyDiscountType" th:field="*{couponPolicyDiscountType}">
                            <option th:each="dtype : ${discountTypes}" th:text="${dtype}" th:value="${dtype}"></option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="couponDiscountValue">í• ì¸ê°’ <span id="discountUnitLabel">(ì›)</span></label>
                        <input class="form-control" id="couponDiscountValue" required th:field="*{couponDiscountValue}" type="number">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-field">
                        <label for="minPrice">ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡</label>
                        <input class="form-control" id="minPrice" th:field="*{minPrice}" type="number" value="0">
                    </div>
                    <div class="form-field">
                        <label for="maxPrice">ìµœëŒ€ í• ì¸ ê¸ˆì•¡</label>
                        <div class="inline-control">
                            <input class="form-control" id="maxPrice" th:field="*{maxPrice}" type="number">
                            <input id="removeMaxPriceFlag" th:field="*{removeMaxPrice}" type="hidden">
                            <button class="remove-btn" data-flag="removeMaxPriceFlag" data-target="#maxPrice" type="button">ì œê±°</button>
                        </div>
                    </div>
                </div>

                <div class="form-section mt-1">
                    <h4>ìœ íš¨ ê¸°ê°„ ì„¤ì •</h4>
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="durationDays">ë°œê¸‰ í›„ ìœ íš¨ ì¼ìˆ˜</label>
                            <div class="inline-control">
                                <input class="form-control" id="durationDays" placeholder="ì˜ˆ: 30" th:field="*{durationDays}" type="number">
                                <input id="removeDurationDaysFlag" th:field="*{removeDurationDays}" type="hidden">
                                <button class="remove-btn" data-flag="removeDurationDaysFlag" data-target="#durationDays" type="button">ì œê±°</button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label>ê³ ì • ê¸°ê°„</label>
                            <div class="inline-control flex-wrap">
                                <input class="form-control flex-1" id="fixedStartDate" th:field="*{fixedStartDate}" type="date">
                                <input class="form-control flex-1" id="fixedEndDate" th:field="*{fixedEndDate}" type="date">
                                <input id="removeFixedDateFlag" th:field="*{removeFixedDate}" type="hidden">
                                <button class="remove-btn" data-flag="removeFixedDateFlag" data-target="#fixedStartDate,#fixedEndDate" type="button">ì œê±°</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-field mt-1">
                    <label>ì ìš© ëŒ€ìƒ ë„ì„œ</label>

                    <input type="hidden" id="targetBookIds" th:field="*{targetBookIds}">

                    <div id="selectedBooksBox" class="selected-items-box">
                        <th:block th:if="${bookNameMap != null and not #maps.isEmpty(bookNameMap)}">
                            <div class="chip" th:each="entry : ${bookNameMap}" th:id="'book-chip-' + ${entry.key}">
                                <span class="mr-4">ğŸ“•</span>
                                <span class="fw-500" th:text="${entry.value}">ì±… ì œëª©</span>
                                <small th:text="'(ID:' + ${entry.key} + ')'"></small>
                                <button type="button" class="chip-remove" th:onclick="|removeBookId('${entry.key}')|">Ã—</button>
                            </div>
                        </th:block>
                    </div>

                    <div class="book-actions">
                        <div class="book-search-cta">
                            <div class="cta-icon">ğŸ”</div>
                            <div class="cta-text">
                                <strong>ë„ì„œ ê²€ìƒ‰ ë° ì¶”ê°€</strong>
                                <span class="muted">ì¿ í° ì ìš© ë„ì„œë¥¼ ë¹ ë¥´ê²Œ ì°¾ì•„ ì¶”ê°€í•˜ì„¸ìš”.</span>
                            </div>
                            <button type="button" class="btn-accent dense" onclick="openBookSearchModal()">ë„ì„œ ì¶”ê°€</button>
                        </div>

                        <input id="removeTargetBookFlag" th:field="*{removeTargetBook}" type="hidden">
                        <button class="remove-btn-outline" data-flag="removeTargetBookFlag" data-target="#targetBookIds" type="button" onclick="clearAllBooks()">
                            ğŸ—‘ï¸ ì ìš© ë„ì„œ ì „ì²´ ì œê±°
                        </button>
                    </div>
                </div>

                <div class="form-field">
                    <label>ì ìš© ëŒ€ìƒ ì¹´í…Œê³ ë¦¬</label>

                    <div class="selected-items-box"
                         th:if="${categoryNameMap != null and not #maps.isEmpty(categoryNameMap)}">
                        <div class="chip category" th:each="entry : ${categoryNameMap}">
                            <span class="mr-4">ğŸ“‚</span>
                            <span class="fw-500" th:text="${entry.value}">ì¹´í…Œê³ ë¦¬ëª…</span>
                        </div>
                    </div>

                    <div id="categoryTreeContainer" class="category-tree-box">
                        <div class="muted" th:if="${#lists.isEmpty(categoryList)}">ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        <ul class="tree-root" th:unless="${#lists.isEmpty(categoryList)}">
                            <th:block th:each="rootCat : ${categoryList}">
                                <th:block th:replace="~{::categoryNode(${rootCat})}"></th:block>
                            </th:block>
                        </ul>
                    </div>
                    <input id="removeTargetCategoryFlag" th:field="*{removeTargetCategory}" type="hidden">
                    <button class="remove-btn mt-5" data-flag="removeTargetCategoryFlag" data-target=".category-tree-box input[type='checkbox']" type="button">ì „ì²´ ì œê±°</button>
                </div>

                <div class="form-field mt-1" th:if="${policy.couponPolicyId != null}">
                    <label for="couponPolicyStatus">ì •ì±… ìƒíƒœ</label>
                    <select class="form-control" id="couponPolicyStatus" th:field="*{couponPolicyStatus}">
                        <option th:each="status : ${statuses}" th:text="${status}" th:value="${status}"></option>
                    </select>
                </div>

                <div class="modal-actions mt-2rem">
                    <a class="btn-ghost" th:href="@{/admin/policies}">ì·¨ì†Œ</a>
                    <button class="btn-primary" type="submit">ì €ì¥í•˜ê¸°</button>
                </div>
            </form>
        </section>
    </main>
</div>

<th:block th:replace="~{fragments/layout :: commonFooter}"></th:block>

<th:block th:fragment="categoryNode(cat)">
    <li class="tree-item" th:if="${cat != null}">
        <div class="tree-row">
            <span th:if="${cat.children != null and not #lists.isEmpty(cat.children)}" class="toggle-btn">â–¶</span>
            <span th:unless="${cat.children != null and not #lists.isEmpty(cat.children)}" class="toggle-placeholder"></span>

            <label class="checkbox-label">
                <input type="checkbox"
                       name="targetCategoryIds"
                       th:value="${cat.id}"
                       th:checked="${policy.targetCategoryIds != null and #lists.contains(policy.targetCategoryIds, cat.id)}"
                       th:id="${'cat_' + cat.id}">
                <span th:text="${cat.name}">ì¹´í…Œê³ ë¦¬ëª…</span>
            </label>
        </div>
        <ul th:if="${cat.children != null and not #lists.isEmpty(cat.children)}" class="sub-tree">
            <th:block th:each="child : ${cat.children}">
                <th:block th:replace="~{::categoryNode(${child})}"></th:block>
            </th:block>
        </ul>
    </li>
</th:block>

<div id="bookSearchModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ë„ì„œ ê²€ìƒ‰</h3>
            <button type="button" class="close-modal" onclick="closeBookSearchModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="search-bar-group">
                <input type="text" id="modalSearchKeyword" class="form-control" placeholder="ë„ì„œëª…, ì €ì, ISBN ê²€ìƒ‰" onkeypress="if(event.key === 'Enter') searchBooks()">
                <button type="button" class="btn-accent" onclick="searchBooks()">ê²€ìƒ‰</button>
            </div>
            <ul id="bookResultList" class="result-list"><li class="no-result">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</li></ul>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        // ==========================================
        // 1. ì¹´í…Œê³ ë¦¬ íŠ¸ë¦¬ (ì´ë²¤íŠ¸ ë¶„ë¦¬)
        // ==========================================
        const treeContainer = document.getElementById('categoryTreeContainer');

        if (treeContainer) {
            // (1) CLICK ì´ë²¤íŠ¸: ì˜¤ì§ í† ê¸€ ë²„íŠ¼(â–¶)ë§Œ ì²˜ë¦¬
            treeContainer.addEventListener('click', function(e) {
                const toggleBtn = e.target.closest('.toggle-btn');
                if (toggleBtn) {
                    e.preventDefault(); e.stopPropagation();
                    const subList = toggleBtn.closest('.tree-item').querySelector('.sub-tree');
                    if (subList) {
                        const isHidden = window.getComputedStyle(subList).display === 'none';
                        if (isHidden) { subList.style.display = 'block'; toggleBtn.classList.add('open'); }
                        else { subList.style.display = 'none'; toggleBtn.classList.remove('open'); }
                    }
                }
            });

            // (2) CHANGE ì´ë²¤íŠ¸: ì²´í¬ë°•ìŠ¤ ê°’ ë³€ê²½ ì²˜ë¦¬ (ìì‹ ë™ê¸°í™”)
            treeContainer.addEventListener('change', function(e) {
                if (e.target.tagName === 'INPUT' && e.target.type === 'checkbox') {
                    const isChecked = e.target.checked;
                    const subList = e.target.closest('.tree-item').querySelector('.sub-tree');
                    // ìì‹ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë™ê¸°í™”
                    if (subList) {
                        subList.querySelectorAll('input[type="checkbox"]').forEach(child => child.checked = isChecked);
                        // ì²´í¬ ì‹œ ìë™ í¼ì¹˜ê¸° (ì„ íƒ ì‚¬í•­)
                        if (isChecked) {
                            subList.style.display = 'block';
                            const btn = e.target.closest('.tree-item').querySelector('.toggle-btn');
                            if(btn) btn.classList.add('open');
                        }
                    }
                    const flag = document.getElementById('removeTargetCategoryFlag');
                    if (flag) flag.value = 'false';
                }
            });
        }


        // ë„ì„œ ê²€ìƒ‰ ëª¨ë‹¬
        window.openBookSearchModal = function() {
            document.getElementById('bookSearchModal').style.display = 'flex';
            const input = document.getElementById('modalSearchKeyword');
            input.value = ''; setTimeout(() => input.focus(), 100);
        };
        window.closeBookSearchModal = function() {
            document.getElementById('bookSearchModal').style.display = 'none';
        };

        window.searchBooks = async function() {
            const keyword = document.getElementById('modalSearchKeyword').value.trim();
            if (!keyword) { alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

            const listEl = document.getElementById('bookResultList');
            listEl.innerHTML = '<li class="no-result">ê²€ìƒ‰ ì¤‘...</li>';

            try {
                const res = await fetch(`/admin/policies/books/search?keyword=${encodeURIComponent(keyword)}&page=0&size=10`);
                if(!res.ok) throw new Error("ê²€ìƒ‰ ì‹¤íŒ¨");

                const data = await res.json();
                const books = data.content;
                listEl.innerHTML = '';

                if(!books || books.length === 0) { listEl.innerHTML = '<li class="no-result">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>'; return; }

                books.forEach(b => {
                    const li = document.createElement('li');
                    li.className = 'result-item';
                    const author = b.contributorNames?.join(', ') || b.publisherNames?.join(', ') || 'ì •ë³´ ì—†ìŒ';
                    const img = b.imagePath || '/images/no-image.png';

                    li.innerHTML = `
                        <img src="${img}" alt="book">
                        <div class="book-info">
                            <span class="book-title">${b.title}</span>
                            <span class="book-author">${author} | ID: ${b.id}</span>
                        </div>
                    `;
                    li.onclick = () => selectBook(b.id, b.title);
                    listEl.appendChild(li);
                });
            } catch(e) {
                console.error(e); listEl.innerHTML = '<li class="no-result">ì˜¤ë¥˜ ë°œìƒ</li>';
            }
        };

        window.selectBook = function(id, title) {
            const input = document.getElementById('targetBookIds');
            let vals = input.value ? input.value.split(',').map(s=>s.trim()).filter(s=>s) : [];

            if(vals.includes(String(id))) { alert("ì´ë¯¸ ì¶”ê°€ëœ ë„ì„œì…ë‹ˆë‹¤."); return; }

            vals.push(id);
            input.value = vals.join(', ');

            // ì¹© ì¶”ê°€
            addBookChip(id, title);

            document.getElementById('removeTargetBookFlag').value = 'false';
            input.disabled = false;
            closeBookSearchModal();
            input.dispatchEvent(new Event('input'));
        };

        function addBookChip(id, title) {
            const box = document.getElementById('selectedBooksBox');
            if(box) {
                const chip = document.createElement('div');
                chip.className = 'chip';
                chip.id = 'book-chip-' + id;
                chip.innerHTML = `
                    <span class="mr-4">ğŸ“•</span>
                    <span class="fw-500">${title}</span>
                    <small>(ID:${id})</small>
                    <button type="button" class="chip-remove" onclick="removeBookId('${id}')">Ã—</button>
                `;
                box.appendChild(chip);
            }
        }

        window.removeBookId = function(id) {
            const input = document.getElementById('targetBookIds');
            let vals = input.value ? input.value.split(',').map(s=>s.trim()).filter(s=>s) : [];

            // ID ì œê±°
            vals = vals.filter(v => v !== String(id));
            input.value = vals.join(', ');

            // ì¹© ì œê±°
            const chip = document.getElementById('book-chip-' + id);
            if(chip) chip.remove();

            input.dispatchEvent(new Event('input'));
        };

        window.clearAllBooks = function() {
            const input = document.getElementById('targetBookIds');
            input.value = '';
            const box = document.getElementById('selectedBooksBox');
            if(box) box.innerHTML = ''; // ì¹© ì „ì²´ ì‚­ì œ

            document.getElementById('removeTargetBookFlag').value = 'true';
            input.dispatchEvent(new Event('input'));
        };

        const searchModal = document.getElementById('bookSearchModal');
        if(searchModal) searchModal.addEventListener('click', (e) => { if (e.target === searchModal) closeBookSearchModal(); });

        // í• ì¸ ë°©ì‹ì— ë”°ë¥¸ ìµœëŒ€ í• ì¸/ë‹¨ìœ„ ì²˜ë¦¬
        const discountTypeSelect = document.getElementById('couponPolicyDiscountType');
        const maxPriceInput = document.getElementById('maxPrice');
        const maxPriceFlag = document.getElementById('removeMaxPriceFlag');
        const discountUnitLabel = document.getElementById('discountUnitLabel');
        const discountValueInput = document.getElementById('couponDiscountValue');

        function syncDiscountControls() {
            const isPercent = discountTypeSelect && discountTypeSelect.value === 'PERCENT';
            if (discountUnitLabel) discountUnitLabel.textContent = isPercent ? '(%)' : '(ì›)';

            if (maxPriceInput && maxPriceFlag) {
                if (isPercent) {
                    maxPriceInput.disabled = false;
                    maxPriceInput.style.backgroundColor = '';
                    maxPriceFlag.value = 'false';
                } else {
                    maxPriceInput.value = '';
                    maxPriceInput.disabled = true;
                    maxPriceInput.style.backgroundColor = '#e9ecef';
                    maxPriceFlag.value = 'true';
                }
            }

            if (discountValueInput) {
                discountValueInput.placeholder = isPercent ? 'ì˜ˆ: 10 (í¼ì„¼íŠ¸)' : 'ì˜ˆ: 5000 (ì›)';
            }
        }

        if (discountTypeSelect) {
            discountTypeSelect.addEventListener('change', syncDiscountControls);
            syncDiscountControls();
        }

        // 3. ìœ íš¨ê¸°ê°„/ì œê±°ë²„íŠ¼ ë“± (ê¸°ì¡´ ë™ì¼, ìƒí˜¸ ë°°íƒ€)
        const syncDuration = () => {
            const dInput = document.getElementById('durationDays');
            const sInput = document.getElementById('fixedStartDate');
            const eInput = document.getElementById('fixedEndDate');
            const dFlag = document.getElementById('removeDurationDaysFlag');
            const fFlag = document.getElementById('removeFixedDateFlag');

            const hasD = dInput.value && !dInput.disabled;
            const hasF = (sInput.value || eInput.value) && !sInput.disabled;

            if(hasD) {
                sInput.disabled = true; eInput.disabled = true;
                sInput.value=''; eInput.value='';
                fFlag.value='true';
                sInput.style.backgroundColor = '#e9ecef';
                eInput.style.backgroundColor = '#e9ecef';
            } else if(dFlag.value !== 'true') {
                sInput.disabled = false; eInput.disabled = false;
                sInput.style.backgroundColor = ''; eInput.style.backgroundColor = '';
            }

            if(hasF) {
                dInput.disabled = true; dInput.value='';
                dFlag.value='true';
                dInput.style.backgroundColor = '#e9ecef';
            } else if(fFlag.value !== 'true') {
                dInput.disabled = false;
                dInput.style.backgroundColor = '';
            }
        };

        ['durationDays', 'fixedStartDate', 'fixedEndDate'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', syncDuration);
        });

        document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const flagId = btn.dataset.flag;
                const targets = btn.dataset.target.split(',');
                if(flagId) document.getElementById(flagId).value = 'true';
                targets.forEach(sel => {
                    const el = document.querySelector(sel);
                    if(el) {
                        if(el.type==='checkbox') el.checked=false; else el.value='';
                        el.disabled=true; el.style.backgroundColor='#e9ecef';
                    }
                });
                // Chip ì œê±° ë¡œì§ (ì„ íƒ ì‚¬í•­)
                if (flagId === 'removeTargetBookFlag') {
                    const box = document.getElementById('selectedBooksBox');
                    if(box) box.innerHTML = '';
                }

                // ìœ íš¨ê¸°ê°„ ìƒí˜¸ í™œì„±í™” ì²˜ë¦¬
                if (flagId === 'removeDurationDaysFlag') {
                    const sInput = document.getElementById('fixedStartDate');
                    const eInput = document.getElementById('fixedEndDate');
                    const fFlag = document.getElementById('removeFixedDateFlag');
                    if (fFlag) fFlag.value = 'false';
                    [sInput, eInput].forEach(el => { if (el) { el.disabled = false; el.style.backgroundColor = ''; } });
                }
                if (flagId === 'removeFixedDateFlag') {
                    const dInput = document.getElementById('durationDays');
                    const dFlag = document.getElementById('removeDurationDaysFlag');
                    if (dFlag) dFlag.value = 'false';
                    if (dInput) { dInput.disabled = false; dInput.style.backgroundColor = ''; }
                }

                syncDuration();
            });
        });

        const flagMap = [ {input: document.getElementById('maxPrice'), flagId: 'removeMaxPriceFlag'}, {input: document.getElementById('targetBookIds'), flagId: 'removeTargetBookFlag'} ];
        flagMap.forEach(({input, flagId}) => {
            if(input) input.addEventListener('input', () => {
                const f = document.getElementById(flagId);
                if(f) { f.value='false'; input.disabled=false; input.style.backgroundColor=''; }
            });
        });

        syncDuration();
    });
</script>
</body>
</html>

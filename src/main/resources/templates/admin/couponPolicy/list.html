<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>관리자 - 쿠폰 정책 관리</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" th:href="@{/css/policyList.css}">
</head>
<body>

<div class="admin-container">

    <div class="page-header">
        <div class="page-title">
            <h2>쿠폰 정책 관리</h2>
            <p>총 <b th:text="${policies != null ? policies.size() : 0}">0</b>개의 정책이 조회되었습니다.</p>
        </div>
        <a href="/admin/policies/create" class="btn-create">
            <span>+ 정책 등록</span>
        </a>
    </div>

    <form action="/admin/policies" method="get" class="filter-toolbar">

        <label for="filterType" style="font-weight: bold; color: #555;">타입:</label>
        <select name="type" id="filterType" class="filter-select">
            <option value="">전체 보기</option>
            <option th:each="type : ${policyTypes}"
                    th:value="${type}"
                    th:text="${type}"
                    th:selected="${type == searchType}">
            </option>
        </select>

        <label for="filterStatus" style="font-weight: bold; color: #555;">상태:</label>
        <select name="status" id="filterStatus" class="filter-select">
            <option value="">전체 보기</option>
            <option th:each="status : ${statuses}"
                    th:value="${status}"
                    th:text="${status.name() == 'ACTIVE' ? '활성' : '비활성'}"
                    th:selected="${status == searchStatus}">
            </option>
        </select>

        <button type="submit" class="btn-reset" style="margin-left: auto; background: #333; color: white; border: none;">🔍 조회</button>
        <a href="/admin/policies" class="btn-reset">↺ 초기화</a>
    </form>

    <div class="table-container">
        <table id="policyTable">
            <thead>
            <tr>
                <th style="width: 5%;">ID</th>
                <th style="width: 10%;">타입</th>
                <th style="width: 25%;">정책 이름</th>
                <th style="width: 15%;">할인 혜택</th>
                <th style="width: 20%;">유효 기간 / 조건</th>
                <th style="width: 10%;">상태</th>
                <th style="width: 15%;">관리</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="policy : ${policies}"
                th:classappend="${policy.couponPolicyStatus?.name() == 'DEACTIVE'} ? 'deactive'">

                <td th:text="${policy.couponPolicyId}">1</td>

                <td>
                    <span class="type-badge"
                          th:classappend="|type-${policy.couponPolicyType}|"
                          th:text="${policy.couponPolicyType}">GENERAL</span>
                </td>

                <td>
                    <a th:href="@{/admin/policies/details/{id}(id=${policy.couponPolicyId})}" class="detail-link">
                        <span th:text="${policy.couponPolicyName}">정책 이름</span>
                    </a>
                </td>

                <td class="discount-info">
                    <th:block th:if="${policy.couponPolicyDiscountType?.name() == 'PERCENT'}">
                        <strong th:text="${policy.couponDiscountValue}">15</strong>% 할인
                    </th:block>
                    <th:block th:if="${policy.couponPolicyDiscountType?.name() == 'FIXED'}">
                        <strong th:text="${#numbers.formatInteger(policy.couponDiscountValue, 0, 'COMMA')}">5,000</strong>원 할인
                    </th:block>
                </td>

                <td style="font-size: 0.9rem;">
                    <div th:if="${policy.durationDays != null}" style="color: #0277bd;">
                        📅 발급 후 <b th:text="${policy.durationDays}">30</b>일간
                    </div>
                    <div th:if="${policy.fixedStartDate != null}">
                        📅 <span th:text="${policy.fixedStartDate}"></span> ~
                        <span th:text="${policy.fixedEndDate}"></span>
                    </div>
                    <div style="color: #666; font-size: 0.8rem; margin-top: 4px;">
                        <span th:text="${#numbers.formatInteger(policy.minPrice, 0, 'COMMA')}">10,000</span>원 이상 구매 시
                    </div>
                </td>

                <td>
                    <div class="status-indicator"
                         th:classappend="|status-${policy.couponPolicyStatus}|">
                        <div class="dot"></div>
                        <span th:text="${policy.couponPolicyStatus?.name() == 'ACTIVE' ? '활성' : '비활성'}">활성</span>
                    </div>
                </td>

                <td>
                    <div class="btn-group-sm">
                        <a th:href="@{/admin/policies/update/{id}(id=${policy.couponPolicyId})}" class="btn-icon">수정</a>

                        <form th:action="@{/admin/policies/delete/{id}(id=${policy.couponPolicyId})}" method="post">
                            <button type="submit" class="btn-icon btn-delete"
                                    onclick="return confirm('정말 이 정책을 비활성화 하시겠습니까?');">중지</button>
                        </form>
                    </div>
                </td>
            </tr>

            <tr th:if="${policies == null or #lists.isEmpty(policies)}">
                <td colspan="7" style="text-align: center; padding: 4rem; color: #999;">
                    검색된 쿠폰 정책이 없습니다.
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination" th:if="${totalPages > 0}">
        <a th:if="${currentPage > 0}"
           th:href="@{/admin/policies(page=${currentPage - 1}, type=${searchType}, status=${searchStatus})}"
           class="page-link">&lt;</a>

        <th:block th:each="i : ${#numbers.sequence(startPage, endPage)}">
            <a th:href="@{/admin/policies(page=${i}, type=${searchType}, status=${searchStatus})}"
               th:text="${i + 1}"
               class="page-link"
               th:classappend="${i == currentPage} ? 'active'">1</a>
        </th:block>

        <a th:if="${currentPage < totalPages - 1}"
           th:href="@{/admin/policies(page=${currentPage + 1}, type=${searchType}, status=${searchStatus})}"
           class="page-link">&gt;</a>
    </div>

</div>

</body>
</html>
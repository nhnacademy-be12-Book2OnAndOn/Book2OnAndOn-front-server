<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>관리자 - 쿠폰 정책 관리</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>

<th:block
        th:replace="~{fragments/layout :: commonHeader(${user} ?: ${session.user}, ${cartCount}, null, null, false)}"></th:block>

<div class="admin-container">
    <th:block th:replace="~{fragments/admin :: adminSidebar('couponpolicies')}"></th:block>

    <main class="admin-content">
        <div class="admin-header">
            <div>
                <p class="eyebrow">쿠폰 정책</p>
                <h2>쿠폰 정책 관리</h2>
                <p class="muted">총 <b th:text="${policies != null ? policies.size() : 0}">0</b>개 정책</p>
            </div>
            <a class="btn-accent" th:href="@{/admin/policies/create}">+ 정책 등록</a>
        </div>

        <form action="/admin/policies" class="admin-toolbar" method="get">
            <label for="filterType">타입</label>
            <select id="filterType" name="type">
                <option value="">전체 보기</option>
                <option th:each="type : ${policyTypes}"
                        th:selected="${type == searchType}"
                        th:text="${type}"
                        th:value="${type}">
                </option>
            </select>

            <label for="filterStatus">상태</label>
            <select id="filterStatus" name="status">
                <option value="">전체 보기</option>
                <option th:each="status : ${statuses}"
                        th:selected="${status == searchStatus}"
                        th:text="${status.name() == 'ACTIVE' ? '활성' : '비활성'}"
                        th:value="${status}">
                </option>
            </select>

            <div class="spacer"></div>
            <button class="btn-primary" type="submit">🔍 조회</button>
            <a class="btn-ghost" href="/admin/policies">↺ 초기화</a>
        </form>

        <div class="table-card">
            <table class="admin-table" id="policyTable">
                <thead>
                <tr>
                    <th style="width: 5%;">ID</th>
                    <th style="width: 10%;">타입</th>
                    <th style="width: 25%;">정책 이름</th>
                    <th style="width: 15%;">할인 혜택</th>
                    <th style="width: 20%;">유효 기간 / 조건</th>
                    <th style="width: 10%;">상태</th>
                    <th style="width: 15%;">관리</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="policy : ${policies}">

                    <td th:text="${policy.couponPolicyId}">1</td>

                    <td>
                        <span class="type-badge"
                              th:classappend="|type-${policy.couponPolicyType}|"
                              th:text="${policy.couponPolicyType}">GENERAL</span>
                    </td>

                    <td>
                        <a class="btn-ghost-link" style="padding: 6px 10px;"
                           th:href="@{/admin/policies/details/{id}(id=${policy.couponPolicyId})}">
                            <span th:text="${policy.couponPolicyName}">정책 이름</span>
                        </a>
                    </td>

                    <td class="discount-info">
                        <th:block th:if="${policy.couponPolicyDiscountType?.name() == 'PERCENT'}">
                            <strong th:text="${policy.couponDiscountValue}">15</strong>% 할인
                        </th:block>
                        <th:block th:if="${policy.couponPolicyDiscountType?.name() == 'FIXED'}">
                            <strong th:text="${#numbers.formatInteger(policy.couponDiscountValue, 0, 'COMMA')}">5,000</strong>원
                            할인
                        </th:block>
                    </td>

                    <td style="font-size: 0.9rem;">
                        <div style="color: #0277bd;"
                             th:if="${policy.durationDays != null}">
                            📅 발급 후 <b th:text="${policy.durationDays}">30</b>일간
                        </div>
                        <div th:if="${policy.durationDays == null}">
                            📅 <span th:text="${policy.fixedStartDate}"></span> ~
                            <span th:text="${policy.fixedEndDate}"></span>
                        </div>
                        <div class="muted" style="margin-top: 4px;">
                            <span th:text="${#numbers.formatInteger(policy.minPrice, 0, 'COMMA')}">10,000</span>원 이상 구매
                            시
                        </div>
                    </td>

                    <td>
                        <span class="status-chip status-delivered"
                              th:if="${policy.couponPolicyStatus?.name() == 'ACTIVE'}">활성</span>
                        <span class="status-chip status-pending"
                              th:if="${policy.couponPolicyStatus?.name() != 'ACTIVE'}">비활성</span>
                    </td>

                    <td class="table-actions">
                        <a class="btn-ghost-link dense"
                           th:href="@{/admin/policies/update/{id}(id=${policy.couponPolicyId})}">수정</a>

                        <form method="post" th:action="@{/admin/policies/delete/{id}(id=${policy.couponPolicyId})}">
                            <button class="btn-danger dense" onclick="return confirm('정말 이 정책을 비활성화 하시겠습니까?');"
                                    type="submit">중지
                            </button>
                        </form>
                    </td>
                </tr>

                <tr th:if="${policies == null or #lists.isEmpty(policies)}">
                    <td colspan="7" style="text-align: center; padding: 4rem; color: #999;">
                        검색된 쿠폰 정책이 없습니다.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination" th:if="${totalPages > 0}">
            <a class="page-link"
               th:href="@{/admin/policies(page=${currentPage - 1}, type=${searchType}, status=${searchStatus})}"
               th:if="${currentPage > 0}">&lt;</a>

            <th:block th:each="i : ${#numbers.sequence(startPage, endPage)}">
                <a class="page-link"
                   th:classappend="${i == currentPage} ? 'active'"
                   th:href="@{/admin/policies(page=${i}, type=${searchType}, status=${searchStatus})}"
                   th:text="${i + 1}">1</a>
            </th:block>

            <a class="page-link"
               th:href="@{/admin/policies(page=${currentPage + 1}, type=${searchType}, status=${searchStatus})}"
               th:if="${currentPage < totalPages - 1}">&gt;</a>
        </div>
    </main>
</div>

<th:block th:replace="~{fragments/layout :: commonFooter}"></th:block>

</body>
</html>

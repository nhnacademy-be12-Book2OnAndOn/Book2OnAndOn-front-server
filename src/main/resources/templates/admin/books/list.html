<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>도서 관리 | 관리자</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>
<th:block th:replace="~{fragments/layout :: commonHeader(${user} ?: ${session.user}, ${cartCount}, null, null, false)}"></th:block>
<div class="admin-container">
    <th:block th:replace="~{fragments/admin :: adminSidebar('books')}"></th:block>

    <main class="admin-content">
        <div class="admin-header">
            <div>
                <div class="eyebrow">BOOKS</div>
                <h2>도서 관리</h2>
                <p class="muted">도서 등록/검색 및 수정</p>
            </div>
            <div class="chip-tabs" style="gap: 10px;">
                <a class="chip-tab chip-ghost" th:href="@{/admin/books/create}">+ 도서 등록</a>
                <form th:action="@{/admin/books/reindex/all}" method="post" style="display:inline;">
                    <button type="submit" class="chip-tab chip-ghost">전체 재인덱싱</button>
                </form>
            </div>
        </div>

        <th:block th:if="${reindexMessage != null}">
            <div class="alert success" th:text="${reindexMessage}"></div>
        </th:block>
        <th:block th:if="${reindexError != null}">
            <div class="alert danger" th:text="${reindexError}"></div>
        </th:block>

        <form class="admin-toolbar" method="get" th:action="@{/admin/books}" id="bookSearchForm" style="align-items: flex-end;">
            <div class="form-field" style="flex: 1; display: flex; gap: 12px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label for="keyword">검색어</label>
                    <input class="form-control" id="keyword" name="keyword" placeholder="제목, 저자, ISBN 등" th:value="${condition.keyword}">
                </div>
                <div style="display: flex; gap: 8px; padding-bottom: 4px;">
                    <button class="btn-ghost" type="button" onclick="location.href='/admin/books'">초기화</button>
                    <button class="btn-primary" type="submit">검색</button>
                </div>
            </div>
            <input type="hidden" name="page" value="0">
            <input type="hidden" name="size" value="10">
        </form>

        <div class="admin-toolbar reindex-toolbar">
            <form th:action="@{/admin/books/reindex/category}" method="post" class="reindex-form">
                <label class="reindex-label" for="categoryReindexInput">카테고리 ID</label>
                <input id="categoryReindexInput" class="reindex-input" type="number" name="categoryId" placeholder="예: 10" required>
                <button class="btn-ghost" type="submit">카테고리 재인덱싱</button>
            </form>
            <form th:action="@{/admin/books/reindex/tag}" method="post" class="reindex-form">
                <label class="reindex-label" for="tagReindexInput">태그 ID</label>
                <input id="tagReindexInput" class="reindex-input" type="number" name="tagId" placeholder="예: 5" required>
                <button class="btn-ghost" type="submit">태그 재인덱싱</button>
            </form>
        </div>

        <section class="admin-detail-card" style="padding: 0;">
            <table class="admin-table">
                <thead>
                <tr>
                    <th style="width: 8%">ID</th>
                    <th>제목</th>
                    <th style="width: 20%">저자</th>
                    <th style="width: 15%">판매가</th>
                    <th style="width: 10%">좋아요</th>
                </tr>
                </thead>
                <tbody id="bookTableBody">
                <tr th:if="${books == null || books.isEmpty()}">
                    <td class="muted" colspan="5" style="text-align: center;">검색 결과가 없습니다.</td>
                </tr>
                <tr th:each="book : ${books}"
                    th:onclick="|location.href='@{/admin/books/{id}/edit(id=${book.id})}'|"
                    style="cursor: pointer;">
                    <td th:text="${book.id}">1</td>
                    <td>
                        <div class="table-title" th:text="${book.title}">도서 제목</div>
                        <div class="muted" th:text="${book.tagNames != null ? #strings.listJoin(book.tagNames, ', ') : ''}"></div>
                    </td>
                    <td th:text="${book.contributorNames != null && !book.contributorNames.isEmpty()} ? ${book.contributorNames[0]} : '미입력'">저자</td>
                    <td th:text="${book.priceSales != null} ? ${#numbers.formatInteger(book.priceSales, 0, 'COMMA')} + '원' : '-'">0원</td>
                    <td th:text="${book.likeCount} ?: 0">0</td>
                </tr>
                </tbody>
            </table>
        </section>

        <div class="pagination"
             th:if="${page != null and page.totalElements > 0}"
             th:with="totalPagesCalc=${(page.totalElements + page.size - 1) / page.size}">
            <a class="page-link"
               th:href="@{/admin/books(page=${page.number - 1}, size=${page.size}, keyword=${condition.keyword})}"
               th:if="${page.number > 0}">&lt;</a>

            <th:block th:each="i : ${#numbers.sequence(0, totalPagesCalc - 1)}">
                <a class="page-link"
                   th:classappend="${i == page.number} ? 'active'"
                   th:href="@{/admin/books(page=${i}, size=${page.size}, keyword=${condition.keyword})}"
                   th:text="${i + 1}">1</a>
            </th:block>

            <a class="page-link"
               th:href="@{/admin/books(page=${page.number + 1}, size=${page.size}, keyword=${condition.keyword})}"
               th:if="${page.number + 1 < totalPagesCalc}">&gt;</a>
        </div>
    </main>
</div>
<th:block th:replace="~{fragments/layout :: commonFooter}"></th:block>
</body>
</html>

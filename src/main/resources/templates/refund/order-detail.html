<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¸ ìƒì„¸ - Book2OnAndOn</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }

        header {
            background: #4A7C59;
            color: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(74, 124, 89, 0.3);
            margin-bottom: 30px;
        }
        header h1 { font-size: 1.8em; margin-bottom: 5px; }
        header p { opacity: 0.9; font-size: 0.95em; }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card h2 {
            color: #4A7C59;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 3px solid #4A7C59;
            padding-bottom: 10px;
        }

        .btn {
            background: #4A7C59;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #3d6549;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 124, 89, 0.3);
        }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-sm { padding: 8px 20px; font-size: 0.9em; }

        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            white-space: nowrap;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-shipping { background: #d1ecf1; color: #0c5460; }
        .status-delivered { background: #d4edda; color: #155724; }
        .status-canceled { background: #f8d7da; color: #721c24; }
        .status-return { background: #fff3cd; color: #856404; }

        .order-detail-content { line-height: 1.8; }
        .order-detail-content h3 {
            color: #4A7C59;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        .order-detail-content h3:first-child { margin-top: 0; }

        .detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .detail-row:last-child { border-bottom: none; }

        .detail-label {
            width: 150px;
            font-weight: 600;
            color: #666;
        }
        .detail-value { flex: 1; color: #333; }

        .item-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #4A7C59;
        }
        .item-name { font-weight: 600; color: #333; margin-bottom: 8px; }
        .item-info { font-size: 0.9em; color: #666; }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .total-amount {
            background: #f0f8f4;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: right;
        }
        .total-amount h3 { color: #4A7C59; font-size: 1.5em; }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .action-buttons { flex-direction: column; align-items: stretch; }
            .btn-sm { width: 100%; }
            .detail-row { flex-direction: column; }
            .detail-label { width: 100%; margin-bottom: 5px; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ“¦ ì£¼ë¬¸ ë‚´ì—­ í™•ì¸</h1>
        <p>Book2OnAndOnì—ì„œ ì£¼ë¬¸í•˜ì‹  ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”</p>
    </header>

    <section class="card">
        <h2>ì£¼ë¬¸ ìƒì„¸ ì •ë³´</h2>

        <div id="actionButtons" class="action-buttons"></div>
        <div id="orderDetailContent" class="order-detail-content"></div>

        <div style="margin-top: 30px;">
            <button id="backBtn" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </section>
</div>

<script>
    const API_BASE = '/orders';

    const ORDER_STATUS = {
        PENDING: { text: "ì£¼ë¬¸ ëŒ€ê¸°", class: "status-pending" },
        SHIPPING: { text: "ë°°ì†¡ì¤‘", class: "status-shipping" },
        DELIVERED: { text: "ë°°ì†¡ ì™„ë£Œ", class: "status-delivered" },
        CANCELED: { text: "ì£¼ë¬¸ ì·¨ì†Œ", class: "status-canceled" },
        COMPLETED: { text: "ì£¼ë¬¸ ì™„ë£Œ", class: "status-delivered" },
        RETURN_REQUESTED: { text: "ë°˜í’ˆ ì‹ ì²­", class: "status-return" },
        RETURN_COMPLETED: { text: "ë°˜í’ˆ ì™„ë£Œ", class: "status-canceled" }
    };

    let currentMode = 'MEMBER_MODE'; // MEMBER_MODE | GUEST_MODE
    let currentOrderDetail = null;

    document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const orderId = params.get('orderId');
        currentMode = params.get('mode') || 'MEMBER_MODE';

        if (!orderId) {
            alert('orderIdê°€ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            goBack();
            return;
        }

        document.getElementById('backBtn').addEventListener('click', goBack);

        await fetchOrderDetail(orderId, currentMode);
        renderOrderDetailContent(currentOrderDetail, currentMode);
    });

    function goBack() {
        // ë¹„íšŒì›ì´ë©´ historyë¥¼ guest ëª¨ë“œë¡œ ì—´ì–´ì£¼ë©´ UXê°€ ìì—°ìŠ¤ëŸ¬ì›€
        const qs = (currentMode === 'GUEST_MODE') ? '?mode=guest' : '';
        window.location.href = `order-history.html${qs}`;
    }

    async function fetchOrderDetail(orderId, mode) {
        // TODO: ì‹¤ì œ ì—°ë™ ì‹œ API í˜¸ì¶œë¡œ êµì²´
        // const res = await fetch(`${API_BASE}/${orderId}`, { headers: ... })
        // currentOrderDetail = await res.json();

        const mockDetailMap = {
            'M1001': { id: 'M1001', date: '2025-12-10', total: 45000, status: 'PENDING', recipient: 'í™ê¸¸ë™', address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬', phone: '010-1234-5678', items: [{ name: 'í´ë¦° ì½”ë“œ', quantity: 1, price: 45000, isWrapped: false }] },
            'M1002': { id: 'M1002', date: '2025-11-20', total: 72000, status: 'DELIVERED', recipient: 'ê¹€ì² ìˆ˜', address: 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ', phone: '010-2345-6789', items: [{ name: 'ê°ì²´ì§€í–¥ ì„¤ê³„', quantity: 2, price: 36000, isWrapped: true, wrapName: 'ê³ ê¸‰ í¬ì¥' }] },
            'M1003': { id: 'M1003', date: '2025-11-01', total: 30000, status: 'SHIPPING', recipient: 'ì´ì˜í¬', address: 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬', phone: '010-3456-7890', items: [{ name: 'ì•Œê³ ë¦¬ì¦˜', quantity: 1, price: 30000, isWrapped: false }] },
            'M1004': { id: 'M1004', date: '2025-10-25', total: 50000, status: 'RETURN_REQUESTED', recipient: 'ë°•ë¯¼ì¤€', address: 'ëŒ€êµ¬ì‹œ ë‹¬ì„œêµ¬', phone: '010-4567-8901', items: [{ name: 'ìë°”ì˜ ì •ì„', quantity: 1, price: 50000, isWrapped: false }] },
            'M1005': { id: 'M1005', date: '2025-10-20', total: 20000, status: 'CANCELED', recipient: 'ìµœí˜„ìš°', address: 'ì¸ì²œì‹œ ì—°ìˆ˜êµ¬', phone: '010-5678-9012', items: [{ name: 'ì›¹ ê°œë°œ', quantity: 1, price: 20000, isWrapped: false }] },
            'G1001': { id: 'G1001', date: '2025-12-15', total: 55000, status: 'DELIVERED', recipient: 'ë¹„íšŒì›', address: 'ì¸ì²œì‹œ ì—°ìˆ˜êµ¬', phone: '010-9999-9999', items: [{ name: 'ë¦¬ì•¡íŠ¸ ë°”ì´ë¸”', quantity: 1, price: 55000, isWrapped: true, wrapName: 'ì—ì½” í¬ì¥' }] },
        };

        currentOrderDetail = mockDetailMap[orderId] || mockDetailMap['M1001'];
    }

    function renderOrderDetailContent(detail, mode) {
        const detailContainer = document.getElementById('orderDetailContent');
        const statusInfo = ORDER_STATUS[detail.status] || { text: detail.status, class: "status-pending" };

        renderActionButtons(detail);

        const itemsHtml = detail.items.map(item => `
      <div class="item-card">
        <div class="item-name">${item.name}</div>
        <div class="item-info">
          ìˆ˜ëŸ‰: ${item.quantity}ê¶Œ |
          ë‹¨ê°€: ${item.price.toLocaleString()}ì› |
          ì†Œê³„: ${(item.price * item.quantity).toLocaleString()}ì›
          ${item.isWrapped ? ` | í¬ì¥: ${item.wrapName}` : ''}
        </div>
      </div>
    `).join('');

        detailContainer.innerHTML = `
      <h3>ì£¼ë¬¸ ì •ë³´</h3>
      <div class="detail-row">
        <span class="detail-label">ì£¼ë¬¸ ë²ˆí˜¸</span>
        <span class="detail-value"><strong>${detail.id}</strong></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">ì£¼ë¬¸ ì¼ì</span>
        <span class="detail-value">${detail.date}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">ì£¼ë¬¸ ìƒíƒœ</span>
        <span class="detail-value"><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></span>
      </div>

      <h3>ë°°ì†¡ ì •ë³´</h3>
      <div class="detail-row">
        <span class="detail-label">ìˆ˜ë ¹ì¸</span>
        <span class="detail-value">${detail.recipient}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">ì—°ë½ì²˜</span>
        <span class="detail-value">${detail.phone}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">ë°°ì†¡ ì£¼ì†Œ</span>
        <span class="detail-value">${detail.address}</span>
      </div>

      <h3>ì£¼ë¬¸ ìƒí’ˆ</h3>
      ${itemsHtml}

      <div class="total-amount">
        <h3>ìµœì¢… ê²°ì œ ê¸ˆì•¡: ${detail.total.toLocaleString()}ì›</h3>
      </div>
    `;

        // ë¹„íšŒì›ì´ë©´ ë’¤ë¡œê°€ê¸° ë¬¸êµ¬ë§Œ UX ë§ì¶¤
        document.getElementById('backBtn').textContent = (mode === 'GUEST_MODE')
            ? 'ë‹¤ë¥¸ ì£¼ë¬¸ ì¡°íšŒí•˜ê¸°'
            : 'ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
    }

    function renderActionButtons(detail) {
        const buttonContainer = document.getElementById('actionButtons');
        buttonContainer.innerHTML = '';

        const status = detail.status;

        // ì£¼ë¬¸ ì·¨ì†Œ: PENDINGì—ì„œë§Œ
        if (status === 'PENDING') {
            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-secondary btn-sm';
            cancelButton.textContent = 'ì£¼ë¬¸ ì·¨ì†Œ';
            cancelButton.onclick = () => handleCancelOrder(detail);
            buttonContainer.appendChild(cancelButton);
        }

        // ë°˜í’ˆ ì‹ ì²­: DELIVEREDì—ì„œë§Œ
        if (status === 'DELIVERED') {
            const returnButton = document.createElement('button');
            returnButton.className = 'btn btn-sm';
            returnButton.textContent = 'ë°˜í’ˆ ì‹ ì²­';
            returnButton.onclick = () => goToRefundForm(detail);
            buttonContainer.appendChild(returnButton);
        }

        // ë°˜í’ˆ ì·¨ì†Œ: RETURN_REQUESTEDì—ì„œë§Œ
        if (status === 'RETURN_REQUESTED') {
            const revokeButton = document.createElement('button');
            revokeButton.className = 'btn btn-danger btn-sm';
            revokeButton.textContent = 'ë°˜í’ˆ ì·¨ì†Œ';
            revokeButton.onclick = () => handleRevokeReturn(detail);
            buttonContainer.appendChild(revokeButton);
        }
    }

    function goToRefundForm(detail) {
        const params = new URLSearchParams({
            orderId: detail.id,
            type: currentMode === 'MEMBER_MODE' ? 'member' : 'guest',
            orderNumber: detail.id
        });

        // ë¹„íšŒì› passwordë¥¼ ì¿¼ë¦¬ë¡œ ë„˜ê¸°ëŠ” ë°©ì‹ì€ ë³´ì•ˆìƒ ì§€ì–‘.
        // ì‹¤ì œë¡œëŠ” ì„œë²„ê°€ â€œë¹„íšŒì› ì¸ì¦ ì™„ë£Œâ€ ìƒíƒœë¥¼ ì„¸ì…˜/í† í°/ì¼íšŒì„± í‚¤ë¡œ ë“¤ê³  ìˆê²Œ ì„¤ê³„í•˜ëŠ” í¸ì´ ì•ˆì „í•¨.
        window.location.href = `refund_request_form.html?${params.toString()}`;
    }

    async function handleCancelOrder(detail) {
        const reason = prompt('ì£¼ë¬¸ ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ìµœëŒ€ 100ì):');
        if (!reason || reason.trim().length === 0) {
            alert('ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        if (reason.length > 100) {
            alert('ì·¨ì†Œ ì‚¬ìœ ëŠ” 100ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (confirm('ì •ë§ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
                // TODO: ì‹¤ì œ API í˜¸ì¶œë¡œ êµì²´
                // await fetch(`${API_BASE}/${detail.id}/cancel`, { method: 'POST', ... })

                alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                goBack();
            } catch (error) {
                alert('ì£¼ë¬¸ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }
    }

    async function handleRevokeReturn(detail) {
        if (confirm('ë°˜í’ˆ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
                // TODO: ì‹¤ì œ API í˜¸ì¶œë¡œ êµì²´
                // await fetch(`${API_BASE}/${detail.id}/return/cancel`, { method: 'POST', ... })

                alert('ë°˜í’ˆ ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                goBack();
            } catch (error) {
                alert('ë°˜í’ˆ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }
    }
</script>
</body>
</html>

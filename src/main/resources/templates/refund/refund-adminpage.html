<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°˜í’ˆ ê´€ë¦¬ - ê´€ë¦¬ì</title>
    <link rel="stylesheet" th:href="@{/css/refund-adminpage.css}">
</head>
<body>
<div class="header">
    <h1>ğŸ› ï¸ ë°˜í’ˆ ê´€ë¦¬</h1>
    <p>ê´€ë¦¬ì í˜ì´ì§€</p>
</div>

<div class="container">
    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="statPending">0</div>
            <div class="stat-label">ì²˜ë¦¬ ëŒ€ê¸°</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statApproved">0</div>
            <div class="stat-label">ìŠ¹ì¸ë¨</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statRejected">0</div>
            <div class="stat-label">ê±°ë¶€ë¨</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="statCompleted">0</div>
            <div class="stat-label">ì²˜ë¦¬ ì™„ë£Œ</div>
        </div>
    </div>

    <!-- í•„í„° -->
    <div class="filters-card">
        <h2>ğŸ” ê²€ìƒ‰ í•„í„°</h2>
        <div class="filters-grid">
            <div class="filter-group">
                <label>ìƒíƒœ</label>
                <select id="filterStatus">
                    <option value="">ì „ì²´</option>
                    <option value="0">ì²˜ë¦¬ ëŒ€ê¸°</option>
                    <option value="1">ìŠ¹ì¸ë¨</option>
                    <option value="2">ê±°ë¶€ë¨</option>
                    <option value="3">ì²˜ë¦¬ ì™„ë£Œ</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ì‹œì‘ì¼</label>
                <input type="date" id="filterStartDate">
            </div>
            <div class="filter-group">
                <label>ì¢…ë£Œì¼</label>
                <input type="date" id="filterEndDate">
            </div>
            <div class="filter-group">
                <label>ì£¼ë¬¸ë²ˆí˜¸</label>
                <input type="text" id="filterOrderNumber" placeholder="ì£¼ë¬¸ë²ˆí˜¸ ì…ë ¥">
            </div>
            <div class="filter-group">
                <label>ì‚¬ìš©ì ê²€ìƒ‰</label>
                <input type="text" id="filterUserKeyword" placeholder="ì´ë¦„, ID ë“±">
            </div>
            <div class="filter-group">
                <label>ë¹„íšŒì› í¬í•¨</label>
                <select id="filterIncludeGuest">
                    <option value="true">í¬í•¨</option>
                    <option value="false">ì œì™¸</option>
                </select>
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn btn-primary" onclick="searchRefunds()">ê²€ìƒ‰</button>
            <button class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- ë°˜í’ˆ ëª©ë¡ í…Œì´ë¸” -->
    <div class="refund-table-container">
        <h2>ğŸ“‹ ë°˜í’ˆ ì‹ ì²­ ëª©ë¡</h2>
        <table>
            <thead>
            <tr>
                <th>ë°˜í’ˆ ID</th>
                <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                <th>ì‹ ì²­ì</th>
                <th>ë°˜í’ˆ ìƒí’ˆ</th>
                <th>ì´ ê¸ˆì•¡</th>
                <th>ì‚¬ìœ </th>
                <th>ì‹ ì²­ì¼</th>
                <th>ìƒíƒœ</th>
                <th>ì‘ì—…</th>
            </tr>
            </thead>
            <tbody id="refundTableBody">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </tbody>
        </table>

        <div class="pagination">
            <button id="btnPrev" onclick="changePage(-1)">ì´ì „</button>
            <span class="page-info">
                    <span id="currentPage">1</span> / <span id="totalPages">1</span>
                </span>
            <button id="btnNext" onclick="changePage(1)">ë‹¤ìŒ</button>
        </div>
    </div>
</div>

<!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ë°˜í’ˆ ìƒì„¸ ì •ë³´</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>

        <div id="modalBody">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
        </div>
    </div>
</div>

<script>
    let currentPage = 0;
    let totalPages = 1;
    let pageSize = 20;
    let refundData = [];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = function() {
        loadRefunds();
        updateStats();
    };

    async function loadRefunds() {
        try {
            const params = new URLSearchParams({
                status: document.getElementById('filterStatus').value,
                startDate: document.getElementById('filterStartDate').value,
                endDate: document.getElementById('filterEndDate').value,
                orderNumber: document.getElementById('filterOrderNumber').value,
                userKeyword: document.getElementById('filterUserKeyword').value,
                includeGuest: document.getElementById('filterIncludeGuest').value,
                page: currentPage,
                size: pageSize
            });

            // API í˜¸ì¶œ ì˜ˆì‹œ
            // const response = await fetch(`/admin/refunds?${params}`, {
            //     headers: {
            //         'Authorization': 'Bearer ' + adminToken
            //     }
            // });
            // const data = await response.json();
            // refundData = data.content;
            // totalPages = data.totalPages;

            // ì„ì‹œ ë°ì´í„°
            refundData = [
                {
                    refundId: 1,
                    orderNumber: '2025123456789',
                    userName: 'í™ê¸¸ë™',
                    userType: 'íšŒì›',
                    userId: 1,
                    items: [
                        { name: 'í´ë¦° ì½”ë“œ', quantity: 2, price: 33000 },
                        { name: 'ë¦¬íŒ©í„°ë§', quantity: 1, price: 35000 }
                    ],
                    totalAmount: 101000,
                    reason: 'ìƒí’ˆ ë¶ˆëŸ‰',
                    detailReason: 'ì±…ì— ì–¼ë£©ì´ ìˆìŠµë‹ˆë‹¤',
                    requestDate: '2024-12-15',
                    status: 0,
                    statusText: 'ì²˜ë¦¬ ëŒ€ê¸°'
                },
                {
                    refundId: 2,
                    orderNumber: '2025123456788',
                    userName: 'ë¹„íšŒì›',
                    userType: 'ë¹„íšŒì›',
                    items: [
                        { name: 'ì´í™í‹°ë¸Œ ìë°”', quantity: 1, price: 36000 }
                    ],
                    totalAmount: 36000,
                    reason: 'ì˜¤ë°°ì†¡',
                    detailReason: 'ë‹¤ë¥¸ ìƒí’ˆì´ ì™”ìŠµë‹ˆë‹¤',
                    requestDate: '2024-12-14',
                    status: 1,
                    statusText: 'ìŠ¹ì¸ë¨'
                },
                {
                    refundId: 3,
                    orderNumber: '2025123456787',
                    userName: 'ê¹€ì² ìˆ˜',
                    userType: 'íšŒì›',
                    userId: 2,
                    items: [
                        { name: 'Design Patterns', quantity: 1, price: 40000 }
                    ],
                    totalAmount: 40000,
                    reason: 'ë‹¨ìˆœ ë³€ì‹¬',
                    detailReason: 'í•„ìš” ì—†ì–´ì¡ŒìŠµë‹ˆë‹¤',
                    requestDate: '2024-12-13',
                    status: 2,
                    statusText: 'ê±°ë¶€ë¨',
                    adminMemo: 'ë°˜í’ˆ ê¸°í•œ ì´ˆê³¼'
                }
            ];

            totalPages = 1; // ì„ì‹œ
            renderTable();

        } catch (error) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('ë°˜í’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function renderTable() {
        const tbody = document.getElementById('refundTableBody');
        tbody.innerHTML = '';

        if (refundData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #666;">ì¡°íšŒëœ ë°˜í’ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        refundData.forEach(refund => {
            const statusClass = getStatusClass(refund.status);
            const itemsText = refund.items.length > 1
                ? `${refund.items[0].name} ì™¸ ${refund.items.length - 1}ê±´`
                : refund.items[0].name;

            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>${refund.refundId}</td>
                    <td>${refund.orderNumber}</td>
                    <td>${refund.userName}<br><small style="color: #666;">(${refund.userType})</small></td>
                    <td>${itemsText}</td>
                    <td><strong>${refund.totalAmount.toLocaleString()}ì›</strong></td>
                    <td>${refund.reason}</td>
                    <td>${refund.requestDate}</td>
                    <td><span class="status-badge ${statusClass}">${refund.statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-info" onclick="viewDetail(${refund.refundId})">ìƒì„¸</button>
                            ${refund.status === 0 ? `
                                <button class="btn btn-sm btn-success" onclick="approveRefund(${refund.refundId})">ìŠ¹ì¸</button>
                                <button class="btn btn-sm btn-danger" onclick="rejectRefund(${refund.refundId})">ê±°ë¶€</button>
                            ` : ''}
                        </div>
                    </td>
                `;
            tbody.appendChild(row);
        });

        document.getElementById('currentPage').textContent = currentPage + 1;
        document.getElementById('totalPages').textContent = totalPages;
        document.getElementById('btnPrev').disabled = currentPage === 0;
        document.getElementById('btnNext').disabled = currentPage === totalPages - 1;
    }

    function getStatusClass(status) {
        const classes = {
            0: 'status-pending',
            1: 'status-approved',
            2: 'status-rejected',
            3: 'status-completed'
        };
        return classes[status] || 'status-pending';
    }

    async function updateStats() {
        // ì‹¤ì œë¡œëŠ” APIë¡œ í†µê³„ ì¡°íšŒ
        // const stats = await fetch('/admin/refunds/stats');
        document.getElementById('statPending').textContent = '5';
        document.getElementById('statApproved').textContent = '12';
        document.getElementById('statRejected').textContent = '3';
        document.getElementById('statCompleted').textContent = '8';
    }

    function searchRefunds() {
        currentPage = 0;
        loadRefunds();
    }

    function resetFilters() {
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        document.getElementById('filterOrderNumber').value = '';
        document.getElementById('filterUserKeyword').value = '';
        document.getElementById('filterIncludeGuest').value = 'true';
        searchRefunds();
    }

    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            loadRefunds();
        }
    }

    function viewDetail(refundId) {
        const refund = refundData.find(r => r.refundId === refundId);
        if (!refund) return;

        const modalBody = document.getElementById('modalBody');
        const itemsHtml = refund.items.map(item => `
                <div class="item-card">
                    <h5>${item.name}</h5>
                    <div class="item-info-row">
                        <span>ìˆ˜ëŸ‰: ${item.quantity}ê°œ</span>
                        <span>ë‹¨ê°€: ${item.price.toLocaleString()}ì›</span>
                        <span>ì†Œê³„: ${(item.price * item.quantity).toLocaleString()}ì›</span>
                    </div>
                </div>
            `).join('');

        modalBody.innerHTML = `
                <div class="detail-section">
                    <h4>ê¸°ë³¸ ì •ë³´</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>ë°˜í’ˆ ID</label>
                            <span>${refund.refundId}</span>
                        </div>
                        <div class="detail-item">
                            <label>ì£¼ë¬¸ë²ˆí˜¸</label>
                            <span>${refund.orderNumber}</span>
                        </div>
                        <div class="detail-item">
                            <label>ì‹ ì²­ì</label>
                            <span>${refund.userName} (${refund.userType})</span>
                        </div>
                        <div class="detail-item">
                            <label>ì‹ ì²­ì¼</label>
                            <span>${refund.requestDate}</span>
                        </div>
                        <div class="detail-item">
                            <label>í˜„ì¬ ìƒíƒœ</label>
                            <span class="status-badge ${getStatusClass(refund.status)}">${refund.statusText}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>ë°˜í’ˆ ìƒí’ˆ ëª©ë¡</h4>
                    <div class="items-list">
                        ${itemsHtml}
                    </div>
                    <div class="detail-item" style="margin-top: 15px; background: #e8f5e9;">
                        <label>ì´ ë°˜í’ˆ ê¸ˆì•¡</label>
                        <span style="color: #4A7C59; font-size: 1.2em;">${refund.totalAmount.toLocaleString()}ì›</span>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>ë°˜í’ˆ ì‚¬ìœ </h4>
                    <div class="detail-item">
                        <label>ì‚¬ìœ  êµ¬ë¶„</label>
                        <span>${refund.reason}</span>
                    </div>
                    <div class="detail-item" style="margin-top: 10px;">
                        <label>ìƒì„¸ ë‚´ìš©</label>
                        <span>${refund.detailReason}</span>
                    </div>
                </div>

                ${refund.adminMemo ? `
                    <div class="detail-section">
                        <h4>ê´€ë¦¬ì ë©”ëª¨</h4>
                        <div class="detail-item">
                            <span>${refund.adminMemo}</span>
                        </div>
                    </div>
                ` : ''}

                ${refund.status === 0 ? `
                    <div class="status-update-form">
                        <h4>ìƒíƒœ ë³€ê²½</h4>
                        <form onsubmit="updateRefundStatus(event, ${refund.refundId})">
                            <div class="form-group">
                                <label>ì²˜ë¦¬ ìƒíƒœ</label>
                                <select id="updateStatus" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="1">ìŠ¹ì¸</option>
                                    <option value="2">ê±°ë¶€</option>
                                    <option value="3">ì™„ë£Œ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ì²˜ë¦¬ ë©”ëª¨</label>
                                <textarea id="updateMemo" placeholder="ì²˜ë¦¬ ì‚¬ìœ ë‚˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">ìƒíƒœ ë³€ê²½</button>
                        </form>
                    </div>
                ` : ''}
            `;

        document.getElementById('detailModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('detailModal').classList.remove('show');
    }

    async function approveRefund(refundId) {
        if (!confirm('ì´ ë°˜í’ˆì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            // const response = await fetch(`/admin/refunds/${refundId}`, {
            //     method: 'PATCH',
            //     headers: {
            //         'Content-Type': 'application/json',
            //         'Authorization': 'Bearer ' + adminToken
            //     },
            //     body: JSON.stringify({
            //         refundStatus: 1
            //     })
            // });

            alert('ë°˜í’ˆì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadRefunds();
            updateStats();

        } catch (error) {
            alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            console.error(error);
        }
    }

    async function rejectRefund(refundId) {
        const reason = prompt('ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
        if (!reason || !reason.trim()) return;

        try {
            // const response = await fetch(`/admin/refunds/${refundId}`, {
            //     method: 'PATCH',
            //     headers: {
            //         'Content-Type': 'application/json',
            //         'Authorization': 'Bearer ' + adminToken
            //     },
            //     body: JSON.stringify({
            //         refundStatus: 2,
            //         adminMemo: reason
            //     })
            // });

            alert('ë°˜í’ˆì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadRefunds();
            updateStats();

        } catch (error) {
            alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            console.error(error);
        }
    }

    async function updateRefundStatus(event, refundId) {
        event.preventDefault();

        const status = document.getElementById('updateStatus').value;
        const memo = document.getElementById('updateMemo').value;

        if (!status) {
            alert('ì²˜ë¦¬ ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            // const response = await fetch(`/admin/refunds/${refundId}`, {
            //     method: 'PATCH',
            //     headers: {
            //         'Content-Type': 'application/json',
            //         'Authorization': 'Bearer ' + adminToken
            //     },
            //     body: JSON.stringify({
            //         refundStatus: parseInt(status),
            //         adminMemo: memo
            //     })
            // });

            alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeModal();
            loadRefunds();
            updateStats();

        } catch (error) {
            alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            console.error(error);
        }
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const modal = document.getElementById('detailModal');
        if (event.target === modal) {
            closeModal();
        }
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>반품 신청 - Book2OnAndOn</title>
    <link rel="stylesheet" th:href="@{/css/refund-form.css}">
</head>
<body>
<div class="container">
    <header>
        <h1>📦 반품 신청</h1>
        <p>선택한 상품에 따라 예상 환불 금액이 자동 계산됩니다</p>
    </header>

    <!-- 서버 에러 메시지 표시용(선택) -->
    <div id="alertBox" class="alert"
         th:classappend="${errorMessage != null} ? ' alert-error show' : ''"
         th:text="${errorMessage}">
    </div>

    <div class="card">
        <h2>반품 신청</h2>

        <!-- userType에 따라 action 분기 -->
        <form id="refundForm"
              th:data-order-id="${orderId}"
              method="post"
              th:action="@{/orders/{orderId}/refunds(orderId=${orderId})}"
              th:object="${refundRequest}">

        <div class="info-box">
                <h3>반품 가능 상품 선택</h3>
                <ul>
                    <li>반품할 상품을 선택해주세요 (선택 시 해당 상품은 ‘전체 수량’ 반품으로 처리됩니다)</li>
                    <li>선택 변경 시 예상 환불 금액이 즉시 반영됩니다</li>
                </ul>
            </div>

            <div class="form-group">
                <label>반품 상품 선택 <span class="required">*</span></label>

                <div class="order-items" id="itemsList">
                    <!-- 반품 가능한 상품이 없을 때 -->
                    <p th:if="${items == null || #lists.isEmpty(items)}"
                       style="text-align:center; color:#666; padding:20px;">
                        반품 가능한 상품이 없습니다.
                    </p>

                    <!-- 상품 목록 -->
                    <div class="item-checkbox"
                         th:if="${items != null && !#lists.isEmpty(items)}"
                         th:each="it, stat : ${items}"
                         th:classappend="${it.activeRefundExists} ? ' disabled' : ''"
                         onclick="toggleRow(this)">
                        <!-- 체크박스: 선택된 품목은 hidden field로 orderItemId, bookId, quantity를 같이 보냄 -->
                        <input type="checkbox"
                               class="item-check"
                               th:id="'item_' + ${it.orderItemId}"
                               th:disabled="${it.activeRefundExists} or ${!it.refundable}"
                               th:attr="data-order-item-id=${it.orderItemId},
                                        data-qty=${it.returnableQuantity},
                                        data-unit-price=${it.unitPrice}"
                               onclick="event.stopPropagation(); toggleRowFromCheckbox(this)">

                        <div class="item-details">
                            <div class="item-name" th:text="${it.bookTitle}">도서명</div>

                            <div class="item-info"
                                 th:text="'반품 가능 수량: ' + ${it.returnableQuantity} + '개 (주문: ' + ${it.orderedQuantity} + '개)'">
                                반품 가능 수량: 1개 (주문: 2개)
                            </div>

                            <div class="item-info"
                                 th:if="${it.activeRefundExists}"
                                 style="color:#b44; font-weight:700;">
                                이미 반품 진행 중인 상품입니다.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 선택된 항목들을 서버로 보내기 위한 hidden inputs(JS가 동적으로 채움) -->
                <div id="selectedItemsHidden"></div>

                <div class="summary-box" id="summaryBox">
                    <div class="summary-row muted">
                        <div class="label" id="summaryCount">상품 0건 · 수량 0개</div>
                        <div class="value"></div>
                    </div>
                    <div class="summary-row">
                        <div class="label">선택 상품 금액</div>
                        <div class="value" id="summarySelectedAmount">0원</div>
                    </div>
                    <div class="summary-row negative">
                        <div class="label">예상 배송비 차감</div>
                        <div class="value" id="summaryShippingDeduction">- 0원</div>
                    </div>
                    <div class="summary-divider"></div>
                    <div class="summary-row total">
                        <div class="label">예상 환불 금액</div>
                        <div class="value" id="summaryExpectedRefund">0원</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>반품 사유 <span class="required">*</span></label>
                <select id="refundReason"
                        th:field="*{refundReason}"
                        required onchange="recalcSummary()">
                    <option value="">선택해주세요</option>
                    <option value="PRODUCT_DEFECT">상품 불량</option>
                    <option value="WRONG_DELIVERY">상품 오배송</option>
                    <option value="CHANGE_OF_MIND">단순 변심</option>
                    <option value="OTHER">기타</option>
                </select>
            </div>

            <div class="form-group">
                <label>상세 사유 <span class="required">*</span></label>
                <textarea id="detailReason"
                          th:field="*{refundReasonDetail}"
                          placeholder="반품 사유를 자세히 입력해주세요 (최소 10자)"
                          required minlength="10"></textarea>
            </div>

            <!-- 게스트 패스워드 필요하면 hidden으로 같이 전송 -->
            <input type="hidden" name="guestPassword"
                   th:if="${userType} == 'guest'"
                   th:value="${guestPassword}">

            <div class="warning-box">
                <h3>⚠️ 반품 안내사항</h3>
                <ul>
                    <li>반품은 상품 수령 후 7일 이내에 신청 가능합니다</li>
                    <li>단순 변심의 경우 왕복 배송비가 발생할 수 있습니다</li>
                    <li>상품 불량/오배송의 경우 배송비는 판매자 부담입니다</li>
                    <li>사용 또는 훼손된 상품은 반품이 제한될 수 있습니다</li>
                </ul>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="goBack()">취소</button>
                <button type="submit" class="btn" id="submitBtn" disabled>반품 신청</button>
            </div>
        </form>
    </div>
</div>

<script th:src="@{/js/refund-form.js}"></script>
</body>
</html>

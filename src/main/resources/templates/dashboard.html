<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${title} ?: 'Book2OnAndOn - 온라인 서점'">Book2OnAndOn - 온라인 서점</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
<th:block
        th:replace="~{fragments/layout :: commonHeader(${user} ?: ${user}, ${cartCount}, ${sectionBlocks}, ${featuredSections}, true)}"></th:block>

<main>
    <section class="hero">
        <div class="container hero-inner">
            <div class="hero-text">
                <p class="hero-badge" th:text="${promotion?.badge} ?: '이번 주 특별 할인'">이번 주 특별 할인</p>
                <h1>책으로 떠나는 <br> 무한한 여행</h1>
                <p class="hero-desc">
                    Book2OnAndOn에서 다양한 장르의 도서를 만나보세요. <br> 베스트셀러부터 숨은 명작까지 모두 한 곳에서.
                </p>
                <div class="hero-actions">
                    <a class="btn primary" th:href="@{/books/bestseller}">베스트셀러 보기</a>
                    <a class="btn secondary" th:href="@{/books/new}">신간 도서</a>
                </div>
                <div class="tag-cloud" th:if="${popularTags != null}">
                    <span class="tag" th:each="tag : ${popularTags}" th:text="'#' + ${tag}">#태그</span>
                </div>
            </div>
            <div class="hero-visual">
                <div class="hero-card">
                    <div class="hero-image">
                        <img alt="추천 도서" th:if="${promotion?.imageUrl != null}" th:src="${promotion.imageUrl}">
                        <img alt="읽는 책"
                             src="https://images.unsplash.com/photo-1473755504818-b72b6dfdc226?auto=format&fit=crop&w=820&q=80"
                             th:if="${promotion?.imageUrl == null}">
                    </div>
                    <div class="hero-price" th:if="${promotion != null}">
                        <p class="label" th:text="${promotion.subtitle} ?: '오늘의 추천 세트'">오늘의 추천 세트</p>
                        <div class="price-row">
                            <span class="sale-price"
                                  th:text="${promotion.salePrice} != null ? '₩' + ${#numbers.formatInteger(promotion.salePrice, 0, 'COMMA')} : ''">₩79,800</span>
                            <span class="original" th:if="${promotion.originalPrice != null}"
                                  th:text="'₩' + ${#numbers.formatInteger(promotion.originalPrice, 0, 'COMMA')}">₩99,000</span>
                        </div>
                        <p class="discount" th:if="${promotion.discountRate != null}"
                           th:text="${promotion.discountRate} + '% 할인'">20% 할인</p>
                        <button class="btn ghost" th:onclick="'addToCart(' + ${promotion.id} + ')'"><span>장바구니 담기</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <th:block th:if="${sectionBlocks != null and #lists.isNotEmpty(sectionBlocks)}">
        <section class="linked-section highlight" th:id="'section-' + (${sectionBlocks[0].id} ?: 0)"
                 th:with="block=${sectionBlocks[0]}">
            <div class="container">
                <div class="section-header">
                    <div>
                        <p class="section-eyebrow"
                           th:text="${block.subtitle} ?: '새로 업데이트된 큐레이션을 살펴보세요'">따끈따끈한 신간을 가장 먼저 만나보세요</p>
                        <h2 th:text="${block.title} ?: '신간 도서'">신간 도서</h2>
                    </div>
                    <a class="view-all"
                       th:href="${block.viewAllLink}"
                       th:if="${block.viewAllLink != null}">전체보기 →</a>
                </div>

                <div class="linked-grid" th:if="${block.books != null and #lists.isNotEmpty(block.books)}">
                    <article class="linked-card" th:each="book : ${block.books}">
                        <div class="linked-thumb">
                            <span class="linked-badge" th:if="${book.tag != null}" th:text="${book.tag}">신간</span>
                            <img th:alt="${book.title}" th:if="${book.imageUrl != null}" th:src="${book.imageUrl}">
                            <div class="thumb-fallback" th:unless="${book.imageUrl != null}">표지 준비중</div>
                        </div>
                        <div class="linked-info">
                            <p class="linked-title" th:text="${book.title} ?: '도서 준비중'">도서 제목</p>
                            <p class="linked-author" th:text="${book.author} ?: '저자 정보 준비중'">저자명</p>
                            <div class="linked-meta">
                                <span class="linked-rating" th:if="${book.rating != null}">
                                    ★ <span th:text="${book.rating}">4.8</span>
                                </span>
                                <div class="linked-price">
                                    <span class="price"
                                          th:text="${book.price != null} ? ${#numbers.formatInteger(book.price, 0, 'COMMA')} + '원' : '가격 준비중'">19,800원</span>
                                    <span class="origin"
                                          th:if="${book.originalPrice != null}"
                                          th:text="${#numbers.formatInteger(book.originalPrice, 0, 'COMMA')} + '원'">25,000원</span>
                                </div>
                            </div>
                            <p class="linked-discount" th:if="${book.discountRate != null}"
                               th:text="${book.discountRate} + '% 할인'">13% 할인</p>
                            <button class="linked-cart" th:onclick="'addToCart(' + ${book.id} + ')'">장바구니</button>
                        </div>
                    </article>
                </div>
                <div class="linked-grid" th:if="${block.books == null or #lists.isEmpty(block.books)}">
                    <article class="linked-card placeholder">
                        <div class="linked-info">
                            <p class="linked-title">도서 준비중</p>
                            <p class="linked-author">곧 새로운 책을 소개할게요.</p>
                        </div>
                    </article>
                </div>
            </div>
        </section>
        <section class="membership-cta" id="section-membership">
            <div class="container cta-inner">
                <div>
                    <p class="cta-eyebrow">회원 전용 혜택</p>
                    <h3>지금 가입하고 첫 구매 시 15% 할인을 받아보세요</h3>
                    <p>새로운 취향을 발견할 준비가 되셨나요? 매주 업데이트되는 큐레이션을 이메일로 받아보세요.</p>
                </div>
                <button class="btn primary" th:onclick="'location.href=\'' + @{/signup} + '\''" type="button">회원가입하기
                </button>
            </div>
        </section>

        <th:block th:each="block,iter : ${sectionBlocks}">
            <section class="linked-section" th:id="'section-' + (${block.id} ?: ${iter.index})"
                     th:if="${iter.index > 0}">
                <div class="container">
                    <div class="section-header">
                        <div>
                            <p class="section-eyebrow"
                               th:text="${block.subtitle} ?: '새로 업데이트된 큐레이션을 살펴보세요'">따끈따끈한 신간을 가장 먼저 만나보세요</p>
                            <h2 th:text="${block.title} ?: '베스트 셀러'">신간 도서</h2>
                        </div>
                        <a class="view-all"
                           th:href="${block.viewAllLink}"
                           th:if="${block.viewAllLink != null}">전체보기 →</a>
                    </div>

                    <div class="linked-grid" th:if="${block.books != null and #lists.isNotEmpty(block.books)}">
                        <article class="linked-card" th:each="book : ${block.books}">
                            <div class="linked-thumb">
                                <span class="linked-badge" th:if="${book.tag != null}" th:text="${book.tag}">베스트</span>
                                <img th:alt="${book.title}" th:if="${book.imageUrl != null}" th:src="${book.imageUrl}">
                                <div class="thumb-fallback" th:unless="${book.imageUrl != null}">표지 준비중</div>
                            </div>
                            <div class="linked-info">
                                <p class="linked-title" th:text="${book.title} ?: '도서 준비중'">도서 제목</p>
                                <p class="linked-author" th:text="${book.author} ?: '저자 정보 준비중'">저자명</p>
                                <div class="linked-meta">
                                    <span class="linked-rating" th:if="${book.rating != null}">
                                        ★ <span th:text="${book.rating}">4.8</span>
                                    </span>
                                    <div class="linked-price">
                                        <span class="price"
                                              th:text="${book.price != null} ? ${#numbers.formatInteger(book.price, 0, 'COMMA')} + '원' : '가격 준비중'">19,800원</span>
                                        <span class="origin"
                                              th:if="${book.originalPrice != null}"
                                              th:text="${#numbers.formatInteger(book.originalPrice, 0, 'COMMA')} + '원'">25,000원</span>
                                    </div>
                                </div>
                                <p class="linked-discount" th:if="${book.discountRate != null}"
                                   th:text="${book.discountRate} + '% 할인'">13% 할인</p>
                                <button class="linked-cart" th:onclick="'addToCart(' + ${book.id} + ')'">장바구니</button>
                            </div>
                        </article>
                    </div>
                    <div class="linked-grid" th:if="${block.books == null or #lists.isEmpty(block.books)}">
                        <article class="linked-card placeholder">
                            <div class="linked-info">
                                <p class="linked-title">도서 준비중</p>
                                <p class="linked-author">베스트 셀러를 준비하고 있습니다.</p>
                            </div>
                        </article>
                    </div>
                </div>
            </section>
        </th:block>
    </th:block>

    <section class="book-section" id="section-new"
             th:unless="${sectionBlocks != null and #lists.isNotEmpty(sectionBlocks)}">
        <div class="container">
            <div class="section-header">
                <div>
                    <p class="section-eyebrow" th:text="${sectionSubtitle} ?: '따끈따끈한 신간을 가장 먼저 만나보세요'">따끈따끈한 신간을 가장 먼저
                        만나보세요</p>
                    <h2 th:text="${sectionTitle} ?: '신간 도서'">신간 도서</h2>
                </div>
                <div class="section-actions">
                    <span class="count" th:text="${totalBooks != null} ? '총 ' + ${totalBooks} + '건' : ''">총 42건</span>
                    <a class="view-all" th:href="@{/books/all}">전체보기 →</a>
                </div>
            </div>

            <div class="book-grid" th:if="${books != null and #lists.isNotEmpty(books)}">
                <div class="book-card" th:each="book : ${books}">
                    <span class="book-badge" th:text="${book.tag} ?: '추천'">추천</span>
                    <a class="book-cover" th:href="@{/books/{id}(id=${book.id})}">
                        <img class="book-image" th:alt="${book.title}" th:if="${book.imageUrl != null}"
                             th:src="${book.imageUrl}">
                        <div class="thumb-fallback" th:unless="${book.imageUrl != null}">표지 준비중</div>
                    </a>
                    <div class="book-details">
                        <p class="book-title" th:text="${book.title} ?: '도서 준비중'">Book Title</p>
                        <p class="book-author" th:text="${book.author} ?: '저자 정보 준비중'">저자명</p>
                        <div class="book-meta">
                            <div class="rating" th:if="${book.rating != null}">
                                <span>★</span>
                                <span th:text="${book.rating}">4.8</span>
                            </div>
                            <div class="price-info">
                                <span class="price"
                                      th:text="${book.price != null} ? '₩' + ${#numbers.formatInteger(book.price, 0, 'COMMA')} : '가격 준비중'">₩79,800</span>
                                <span class="origin" th:if="${book.originalPrice != null}"
                                      th:text="'₩' + ${#numbers.formatInteger(book.originalPrice, 0, 'COMMA')}">₩99,000</span>
                            </div>
                        </div>
                    </div>
                    <button class="cart-button" th:onclick="'addToCart(' + ${book.id} + ')'"><span>장바구니</span></button>
                </div>
            </div>
            <div class="book-grid" th:if="${books == null or #lists.isEmpty(books)}">
                <div class="book-card placeholder">
                    <div class="book-details">
                        <p class="book-title">도서 준비중</p>
                        <p class="book-author">신간 데이터를 불러오는 중입니다.</p>
                    </div>
                </div>
            </div>

            <div class="pagination" th:if="${totalPages > 1}">
                <button th:if="${currentPage > 0}"
                        th:onclick="'location.href=\'' + @{/books(page=${currentPage - 1})} + '\''">이전
                </button>
                <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                    <button th:classappend="${i == currentPage} ? 'active' : ''"
                            th:onclick="'location.href=\'' + @{/books(page=${i})} + '\''" th:text="${i + 1}">1
                    </button>
                </th:block>
                <button th:if="${currentPage < totalPages - 1}"
                        th:onclick="'location.href=\'' + @{/books(page=${currentPage + 1})} + '\''">다음
                </button>
            </div>
        </div>
    </section>

    <section class="membership-cta" id="section-membership"
             th:unless="${sectionBlocks != null and #lists.isNotEmpty(sectionBlocks)}">
        <div class="container cta-inner">
            <div>
                <p class="cta-eyebrow">회원 전용 혜택</p>
                <h3>지금 가입하고 첫 구매 시 15% 할인을 받아보세요</h3>
                <p>새로운 취향을 발견할 준비가 되셨나요? 매주 업데이트되는 큐레이션을 이메일로 받아보세요.</p>
            </div>
            <button class="btn primary" th:onclick="'location.href=\'' + @{/signup} + '\''" type="button">회원가입하기
            </button>
        </div>
    </section>

    <section class="book-collection" th:if="${featuredSections != null}"
             th:unless="${sectionBlocks != null and #lists.isNotEmpty(sectionBlocks)}">
        <div class="container" th:each="collection,iter : ${featuredSections}"
             th:id="'section-featured-' + ${iter.index}">
            <div class="section-header">
                <div>
                    <p class="section-eyebrow" th:text="${collection.subtitle} ?: '가장 많은 사랑을 받은 책들'">가장 많은 사랑을 받은 책들</p>
                    <h2 th:text="${collection.title} ?: '베스트 셀러'">이번 주 베스트셀러</h2>
                </div>
                <a class="view-all" th:href="${collection.link}">전체보기 →</a>
            </div>
            <div class="book-grid" th:if="${collection.books != null and #lists.isNotEmpty(collection.books)}">
                <div class="book-card" th:each="book : ${collection.books}">
                    <span class="book-badge" th:text="${book.tag} ?: '추천'">추천</span>
                    <a class="book-cover" th:href="@{/books/{id}(id=${book.id})}">
                        <img class="book-image" th:alt="${book.title}" th:if="${book.imageUrl != null}"
                             th:src="${book.imageUrl}">
                        <div class="thumb-fallback" th:unless="${book.imageUrl != null}">표지 준비중</div>
                    </a>
                    <div class="book-details">
                        <p class="book-title" th:text="${book.title} ?: '도서 준비중'">Book Title</p>
                        <p class="book-author" th:text="${book.author} ?: '저자 정보 준비중'">저자명</p>
                        <div class="book-meta">
                            <div class="rating" th:if="${book.rating != null}">
                                <span>★</span>
                                <span th:text="${book.rating}">4.8</span>
                            </div>
                            <div class="price-info">
                                <span class="price"
                                      th:text="${book.price != null} ? '₩' + ${#numbers.formatInteger(book.price, 0, 'COMMA')} : '가격 준비중'">₩79,800</span>
                                <span class="origin" th:if="${book.originalPrice != null}"
                                      th:text="'₩' + ${#numbers.formatInteger(book.originalPrice, 0, 'COMMA')}">₩99,000</span>
                            </div>
                        </div>
                    </div>
                    <button class="cart-button" th:onclick="'addToCart(' + ${book.id} + ')'"><span>장바구니</span></button>
                </div>
            </div>
            <div class="book-grid" th:if="${collection.books == null or #lists.isEmpty(collection.books)}">
                <div class="book-card placeholder">
                    <div class="book-details">
                        <p class="book-title">도서 준비중</p>
                        <p class="book-author">베스트 셀러 데이터를 준비하고 있습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="book-collection" id="section-bestseller-week"
             th:if="${featuredSections == null and (sectionBlocks == null or #lists.isEmpty(sectionBlocks))}">
        <div class="container">
            <div class="section-header">
                <div>
                    <p class="section-eyebrow">이번주 베스트 셀러</p>
                    <h2>이번주 베스트 셀러</h2>
                </div>
            </div>
            <div class="book-grid">
                <div class="book-card placeholder">
                    <div class="book-details">
                        <p class="book-title">도서 준비중</p>
                        <p class="book-author">곧 이번주 베스트 셀러를 만나보실 수 있습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="book-collection" id="section-bestseller-yesterday"
             th:if="${featuredSections == null and (sectionBlocks == null or #lists.isEmpty(sectionBlocks))}">
        <div class="container">
            <div class="section-header">
                <div>
                    <p class="section-eyebrow">어제 베스트 셀러</p>
                    <h2>어제 베스트 셀러</h2>
                </div>
            </div>
            <div class="book-grid">
                <div class="book-card placeholder">
                    <div class="book-details">
                        <p class="book-title">도서 준비중</p>
                        <p class="book-author">어제의 베스트 셀러 데이터를 준비하고 있습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="book-collection" id="section-popular"
             th:if="${featuredSections == null and (sectionBlocks == null or #lists.isEmpty(sectionBlocks))}">
        <div class="container">
            <div class="section-header">
                <div>
                    <p class="section-eyebrow">가장 많이 본 책</p>
                    <h2>인기 도서</h2>
                </div>
            </div>
            <div class="book-grid">
                <div class="book-card placeholder">
                    <div class="book-details">
                        <p class="book-title">도서 준비중</p>
                        <p class="book-author">인기 도서를 수집 중입니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

</main>

<th:block th:replace="~{fragments/layout :: commonFooter}"></th:block>

<script th:inline="javascript">
    /*<![CDATA[*/
    function addToCart(bookId) {
        fetch('/api/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({bookId: bookId})
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const badge = document.querySelector('[data-cart-count]');
                    if (badge) {
                        badge.textContent = parseInt(badge.textContent || '0', 10) + 1;
                    }
                    alert('장바구니에 추가되었습니다.');
                } else {
                    alert('장바구니 추가에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('오류가 발생했습니다.');
            });
    }

    /*]]>*/
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko"
      layout:decorate="~{layout/mypage-layout}"
      th:with="sidebarActive='orders'"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title layout:fragment="title">마이페이지 - 주문 내역</title>
    <th:block layout:fragment="extraHead">
        <link rel="stylesheet" th:href="@{/css/OrderHistory.css}">
        <script th:inline="javascript">
            /*<![CDATA[*/
            window.IS_MEMBER_LOGGED_IN = /*[[${(user != null) or (session.user != null)}]]*/ false;
            window.USER_ID = /*[[${user != null ? user.userId : (session.user != null ? session.user.userId : null)}]]*/ null;
            window.INITIAL_ORDERS = /*[[${orderList != null ? orderList.content : null}]]*/ [];
            window.USE_SERVER_PAGING = /*[[${orderList != null and orderList.totalPages > 1}]]*/ false;
            /*]]>*/
        </script>
    </th:block>
</head>

<body>
<div class="mypage-content order-history-page" layout:fragment="content">
    <div class="order-history-shell">
        <div class="page-hero-card">
            <div>
                <h2>주문 내역</h2>
                <p class="muted">
                    <span th:text="${(user != null && user.nickname != null) ? user.nickname : (session.user != null ? session.user.nickname : '회원')}"></span>님의 주문을 확인하고
                    관리하세요.
                </p>
            </div>
        </div>

        <div class="card-shell">

        <section class="order-card guest-form-container"
                 id="guestLookupSection"
                 th:if="${user == null and session.user == null}">
            <div class="card-heading">
                <p class="eyebrow">비회원</p>
                <h3>비회원 주문 조회</h3>
                <p class="muted">주문 시 입력했던 정보로 조회할 수 있습니다.</p>
            </div>
            <form class="stacked-form" id="guestLookupForm">
                <input id="guestOrderId" placeholder="주문 번호" required type="text">
                <input id="guestOrderer" placeholder="주문자 이름" required type="text">
                <input id="guestPassword" placeholder="주문 비밀번호 (또는 연락처 끝 4자리)" required type="password">
                <button class="btn-primary full" type="submit">주문 조회</button>
            </form>
            <p class="muted helper-text">
                혹은 <a class="link-cta accent" id="memberLoginLink" th:href="@{/users/me/orders}">로그인</a> 하여 전체 주문 내역을
                확인하세요.
            </p>
        </section>

        <section class="order-card order-list-container"
                 id="memberHistorySection"
                 th:if="${user != null or session.user != null}">
            <div class="history-header-wrapper">
                <div>
                    <p class="eyebrow">회원</p>
                    <h3>전체 주문 내역</h3>
                    <p class="muted">
                        <span th:text="${(user != null && user.nickname != null) ? user.nickname : (session.user != null ? session.user.nickname : '회원')}"></span>님의 주문 기록입니다.
                    </p>
                </div>

                <select class="select-compact" id="sortOrderSelect">
                    <option value="latest">최신순 (기본)</option>
                    <option value="oldest">과거순</option>
                </select>
            </div>

            <div class="order-filter-box">
                <div class="quick-filter-bar">
                    <div class="quick-filter-buttons" id="quickFilterButtons">
                        <button type="button" data-status="all" class="active">전체</button>
                        <button type="button" data-status="PENDING">주문 대기</button>
                        <button type="button" data-status="SHIPPING">배송중</button>
                        <button type="button" data-status="DELIVERED">배송 완료</button>
                        <button type="button" data-status="COMPLETED">주문 완료</button>
                    </div>
                    <div class="quick-search">
                        <input type="text" id="quickKeyword" placeholder="주문번호 / 상품명 / 수령인 검색">
                        <button type="button" id="quickSearchButton">검색</button>
                    </div>
                </div>

                <form id="orderFilterForm">
                    <div class="filter-group">
                        <label>주문 기간</label>
                        <div class="filter-inline">
                            <select id="filterYear"></select>
                            <span class="divider">년</span>
                            <select id="filterMonth"></select>
                            <span class="divider">월</span>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>주문 검색</label>
                        <div class="filter-inline">
                            <select id="searchType">
                                <option value="orderItemName">주문 상품</option>
                                <option value="orderNumber">주문 번호</option>
                                <option value="recipientName">수령인</option>
                            </select>
                            <input id="searchKeyword" placeholder="검색어 입력" type="text">
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>배송 상태</label>
                        <select id="filterStatus"></select>
                    </div>

                    <div class="filter-actions">
                        <button class="btn-primary" id="filterSearchButton" type="submit">찾기</button>
                        <button class="btn-secondary" id="filterResetButton" type="button">초기화</button>
                    </div>
                </form>
            </div>

            <div id="orderList" th:if="${orderList != null and orderList.content != null and !orderList.content.isEmpty()}">
                <article class="order-card-entry order-item"
                         th:each="order : ${orderList.content}"
                         th:attr="data-order-id=${order.orderNumber}">
                    <div class="order-entry-head">
                        <div class="order-id-row">
                            <a class="order-number"
                               th:href="@{/orders/{orderNumber}(orderNumber=${order.orderNumber})}"
                               th:text="${order.orderNumber}">ORD-0000</a>
                            <span class="order-date"
                                  th:text="${order.orderDateTime != null ? #temporals.format(order.orderDateTime, 'yyyy-MM-dd HH:mm') : ''}">2025-01-01 12:00</span>
                        </div>
                        <span class="order-status"
                              th:classappend="${order.orderStatus != null} ? ' status-' + ${order.orderStatus.name().toLowerCase()} : ''"
                              th:text="${order.orderStatus != null ? order.orderStatus.getDescription() : '상태 미정'}">상태</span>
                    </div>

                    <div class="order-entry-body">
                        <div class="order-title" th:text="${order.orderTitle}">대표 상품명</div>
                        <div class="order-meta">
                            <span class="order-amount"
                                  th:text="${#numbers.formatInteger(order.totalAmount, 0, 'COMMA')} + '원'">0원</span>
                        </div>
                    </div>
                </article>
            </div>
            <p id="noOrdersMessage"
               th:if="${orderList == null or orderList.content == null or orderList.content.isEmpty()}">주문 내역이 없습니다.</p>

            <div class="order-pagination"
                 th:if="${orderList != null and orderList.totalPages > 1}">
                <a class="page-btn prev"
                   th:classappend="${orderList.first} ? ' disabled' : ''"
                   th:href="@{/orders/my-order(page=${orderList.number - 1}, size=${orderList.size})}">‹</a>
                <a th:each="p : ${pageNumbers}"
                   th:href="@{/orders/my-order(page=${p - 1}, size=${orderList.size})}"
                   th:text="${p}"
                   th:classappend="${p - 1 == orderList.number} ? ' active' : ''"
                   class="page-num"></a>
                <a class="page-btn next"
                   th:classappend="${orderList.last} ? ' disabled' : ''"
                   th:href="@{/orders/my-order(page=${orderList.number + 1}, size=${orderList.size})}">›</a>
            </div>
        </section>

        <div class="order-guide-section">
            <div class="guide-grid">
                <div class="guide-copy">
                    <span class="guide-badge">TIP</span>
                    <p>발송 전 주문은 주문상세내역에서 <strong>주문취소</strong>와 <strong>배송지 변경</strong>이 가능해요.</p>
                    <p>주문번호를 클릭하면 상세 내역을 바로 확인할 수 있습니다.</p>
                </div>

                <div class="timeline-card">
                    <div class="process-container">
                        <div class="process-step">
                            <div class="step-icon">📄</div>
                            <span>주문접수(대기)</span>
                            <p class="step-desc">입금 전 상태입니다</p>
                        </div>
                        <div class="process-arrow">▶</div>
                        <div class="process-step">
                            <div class="step-icon">💳</div>
                            <span>결제완료</span>
                            <p class="step-desc">재고 확인 중</p>
                        </div>
                        <div class="process-arrow">▶</div>
                        <div class="process-step">
                            <div class="step-icon">🎁</div>
                            <span>출고작업중</span>
                            <p class="step-desc">상품 포장 중</p>
                        </div>
                        <div class="process-arrow">▶</div>
                        <div class="process-step">
                            <div class="step-icon">🚚</div>
                            <span>배송중/완료</span>
                            <p class="step-desc">택배사 전달 완료</p>
                        </div>
                    </div>
                    <div class="guide-footer-bar">
                        <div class="cancel-zone">주문취소 가능</div>
                        <div class="return-zone">반품을 이용해주세요</div>
                    </div>
                </div>
            </div>
        </div>

        <section class="order-card order-list-container hidden" id="orderDetailSection">
            <div class="card-heading">
                <p class="eyebrow">상세</p>
                <h3>주문 상세 정보</h3>
            </div>

            <div class="action-buttons-wrapper" id="actionButtons"></div>

            <div id="orderDetailContent"></div>

            <button class="btn-secondary ghost" id="backToHistory" style="margin-top: 20px;">목록으로 돌아가기</button>
        </section>

        <div class="modal hidden" id="actionModal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h3 id="modalTitle"></h3>

                <div id="modalContent">
                    <p><strong>주문 번호:</strong> <span id="modalOrderId"></span></p>
                    <p><strong>취소/반품 금액:</strong> <span id="modalAmount"></span>원</p>

                    <div class="form-group" id="reasonGroup">
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn-primary" id="confirmActionButton">확인 및 요청</button>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script src="/js/OrderHistory.js"></script>
</div>
</body>
</html>

<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mypage-layout}">
<head>
    <title layout:fragment="title">리뷰 수정</title>
    <th:block layout:fragment="extraHead">
        <style>
            .edit-container { background: #fff; padding: 30px; border-radius: 8px; border: 1px solid #eee; }
            .form-group { margin-bottom: 24px; }
            .form-label { display: block; font-weight: 700; margin-bottom: 8px; color: #333; }
            .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }

            /* 별점 */
            .star-rating { display: inline-flex; gap: 5px; cursor: pointer; }
            .star { font-size: 2rem; color: #e0e0e0; transition: color 0.2s; }
            .star.filled { color: #ffc107; }

            /* 이미지 관리 */
            .current-images { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
            .img-wrapper { position: relative; width: 80px; height: 80px; border-radius: 6px; overflow: hidden; border: 1px solid #ddd; }
            .img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
            .btn-del-img {
                position: absolute; top: 0; right: 0;
                background: rgba(0,0,0,0.6); color: #fff; border: none;
                width: 24px; height: 24px; cursor: pointer;
                display: flex; align-items: center; justify-content: center;
                z-index: 10; /* 버튼이 이미지 위에 확실히 뜨도록 */
            }

            .btn-row { display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px; }
            .btn { padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; }
            .btn-cancel { background: #f1f3f5; color: #333; }
            .btn-submit { background: #1f4e3c; color: #fff; }
        </style>
    </th:block>
</head>

<body>
<div layout:fragment="content">
    <div class="dashboard-header">
        <h2>리뷰 수정</h2>
        <p class="muted">작성했던 리뷰 내용을 수정합니다.</p>
    </div>

    <div class="edit-container">
        <form th:action="@{/books/reviews/{id}(id=${review.id})}" method="post" enctype="multipart/form-data">
            <input type="hidden" name="bookId" th:value="${bookId}">

            <div class="form-group">
                <label class="form-label">제목 <span style="color:red">*</span></label>
                <input type="text" name="title" class="form-control" th:value="${review.title}" required>
            </div>

            <div class="form-group">
                <label class="form-label">별점 <span style="color:red">*</span></label>
                <div class="star-rating" id="starContainer">
                    <input type="hidden" name="score" id="scoreInput" th:value="${review.score}">
                    <span th:each="i : ${#numbers.sequence(1,5)}"
                          class="star"
                          th:classappend="${i <= review.score} ? 'filled'"
                          th:data-value="${i}"
                          onclick="setScore(this)">★</span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">내용 (10자 이상) <span style="color:red">*</span></label>
                <textarea name="content" class="form-control" rows="8"
                          minlength="10" maxlength="500" required
                          th:text="${review.content}"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">이미지 수정</label>

                <div class="current-images" th:if="${review.images != null and !review.images.isEmpty()}">
                    <div class="img-wrapper" th:each="img : ${review.images}" th:id="'img-' + ${img.id}">
                        <img th:src="${img.imagePath}">
                        <button type="button" class="btn-del-img"
                                th:data-id="${img.id}" onclick="deleteImage(this)">✕</button>
                    </div>
                </div>
                <div id="deleteInputs"></div>

                <input type="file" name="images" class="form-control" accept="image/*" multiple>
                <p class="muted" style="font-size:0.85rem; margin-top:5px;">새 이미지를 추가하려면 파일을 선택하세요.</p>
            </div>

            <div class="btn-row">
                <a th:href="@{/users/me/reviews}" class="btn btn-cancel">취소</a>
                <button type="submit" class="btn btn-submit">수정 완료</button>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        /* 별점 클릭 로직 */
        function setScore(element) {
            const val = element.getAttribute('data-value');
            document.getElementById('scoreInput').value = val;

            const stars = document.querySelectorAll('#starContainer .star');
            stars.forEach(s => {
                const starVal = s.getAttribute('data-value');
                if(parseInt(starVal) <= parseInt(val)) {
                    s.classList.add('filled');
                } else {
                    s.classList.remove('filled');
                }
            });
        }

        /* 이미지 삭제 로직 */
        function deleteImage(btn) {
            const id = btn.getAttribute('data-id');

            // 1. 화면에서 숨김
            const wrapper = document.getElementById('img-' + id);
            if(wrapper) wrapper.style.display = 'none';

            // 2. hidden input 추가 (name="deleteImageIds")
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'deleteImageIds'; // DTO 필드명 일치 필수
            input.value = id;

            document.getElementById('deleteInputs').appendChild(input);
        }
    </script>
</div>
</body>
</html>
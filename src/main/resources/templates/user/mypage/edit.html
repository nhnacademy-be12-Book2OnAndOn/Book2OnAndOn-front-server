<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout/mypage-layout :: layout(
        title = ~{::title},
        sidebarActive = 'edit',
        content = ~{::content}
      )}">
<head>
    <title>내 정보 수정</title>
    <style>
        .input-group {
            display: flex;
            gap: 10px;
        }

        .btn-verify {
            padding: 10px 15px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-verify:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .text-success {
            color: green;
            font-size: 0.9em;
        }

        .text-danger {
            color: red;
            font-size: 0.9em;
        }

        .mt-2 {
            margin-top: 10px;
        }
    </style>
</head>

<body>
<div th:fragment="content">

    <div class="address-form-container">
        <h2>⚙️ 회원 정보 수정</h2>

        <div th:if="${error}" class="error-box" th:text="${error}"></div>

        <form th:action="@{/users/me/edit}" th:object="${userUpdateRequest}" method="post"
              onsubmit="return validateForm()">

            <div class="form-field">
                <label for="name">이름</label>
                <input type="text" id="name" th:field="*{name}" required>
            </div>

            <div class="form-field">
                <label for="nickname">닉네임</label>
                <input type="text" id="nickname" th:field="*{nickname}" required>
            </div>

            <div class="form-field">
                <label for="email">이메일</label>
                <div class="input-group">
                    <input type="email" id="email" th:field="*{email}" required oninput="checkEmailChanged()"
                           style="flex: 1;">
                    <button type="button" id="btnSendCode" class="btn-verify" onclick="sendVerification()" disabled>
                        인증번호 전송
                    </button>
                </div>

                <div id="verificationArea" class="mt-2" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="verifyCode" placeholder="인증번호 6자리"
                               style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" class="btn-verify" onclick="confirmVerification()">확인</button>
                    </div>
                    <small id="verifyMessage" class="mt-2" style="display: block;"></small>
                </div>

                <input type="hidden" id="originalEmail" th:value="*{email}">
            </div>

            <div class="form-field">
                <label for="phone">휴대폰 번호</label>
                <input type="text" id="phone" th:field="*{phone}" placeholder="01000000000" required>
            </div>

            <div class="form-actions">
                <a href="/users/me" class="btn-cancel">취소</a>
                <button type="submit" class="submit-btn">수정 저장</button>
            </div>

        </form>
    </div>

    <script>
        const originalEmail = document.getElementById('originalEmail').value;
        let isEmailVerified = true;

        // 1. 이메일 변경 감지
        function checkEmailChanged() {
            const currentEmail = document.getElementById('email').value;
            const btnSendCode = document.getElementById('btnSendCode');
            const verificationArea = document.getElementById('verificationArea');
            const verifyMessage = document.getElementById('verifyMessage');

            if (currentEmail !== originalEmail) {
                // 변경됨 -> 인증 필요
                btnSendCode.disabled = false;
                isEmailVerified = false;
                verifyMessage.textContent = '';
            } else {
                // 원상복구 -> 인증 불필요
                btnSendCode.disabled = true;
                verificationArea.style.display = 'none';
                isEmailVerified = true;
            }
        }

        // 2. 인증번호 발송 요청 (함수명: sendVerification)
        function sendVerification() {
            const email = document.getElementById('email').value;

            if (!email || !email.includes('@')) {
                alert('올바른 이메일 형식을 입력해주세요.');
                return;
            }

            const btn = document.getElementById('btnSendCode');
            btn.innerText = "전송중...";
            btn.disabled = true;

            fetch('/email/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'email=' + encodeURIComponent(email)
            })
                .then(function (response) {
                    if (response.ok) {
                        alert('인증번호가 발송되었습니다.');
                        document.getElementById('verificationArea').style.display = 'block';
                        btn.innerText = "재전송";
                        document.getElementById('verifyCode').value = '';
                        document.getElementById('verifyCode').focus();
                        btn.disabled = false; // 성공 시 버튼 활성화
                    } else {
                        return response.text().then(function (text) {
                            throw new Error(text);
                        });
                    }
                })
                .catch(function (error) {
                    console.error('Error:', error);
                    alert("발송 실패: " + error.message);

                    // 에러 나도 버튼은 다시 눌러볼 수 있게 복구
                    btn.disabled = false;
                    btn.innerText = "인증번호 전송";
                });
        }

        // 3. 인증번호 확인 요청 (함수명: confirmVerification)
        function confirmVerification() {
            const email = document.getElementById('email').value;
            const code = document.getElementById('verifyCode').value;
            const msgElem = document.getElementById('verifyMessage');

            if (!code) {
                alert('인증번호를 입력해주세요.');
                return;
            }

            fetch('/email/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'email=' + encodeURIComponent(email) + '&code=' + encodeURIComponent(code)
            })
                .then(function (response) {
                    if (response.ok) {
                        msgElem.textContent = '인증이 완료되었습니다.';
                        msgElem.className = 'text-success';
                        isEmailVerified = true;

                        document.getElementById('btnSendCode').disabled = true;
                        document.getElementById('email').readOnly = true;
                    } else {
                        throw new Error('인증번호가 일치하지 않습니다.');
                    }
                })
                .catch(function (error) {
                    msgElem.textContent = error.message;
                    msgElem.className = 'text-danger';
                    isEmailVerified = false;
                });
        }

        // 4. 폼 전송 검증
        function validateForm() {
            const currentEmail = document.getElementById('email').value;

            if (currentEmail !== originalEmail && !isEmailVerified) {
                alert('변경된 이메일에 대한 인증이 필요합니다.');
                return false;
            }
            return true;
        }
    </script>

</div>
</body>
</html>
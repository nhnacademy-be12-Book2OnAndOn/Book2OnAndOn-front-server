<!DOCTYPE html>
<html lang="ko" th:replace="~{layout/mypage-layout :: layout(
        title = ~{::title},
        sidebarActive = 'edit',
        content = ~{::content},
        extraHead = ~{::extraHead}
      )}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ë‚´ ì •ë³´ ìˆ˜ì •</title>
    <th:block th:fragment="extraHead">
        <link rel="stylesheet" th:href="@{/css/mypage-edit.css}">
    </th:block>
</head>

<body>
<div th:fragment="content">
    <div class="address-form-container no-card">
        <h2>ì •ë³´ ê´€ë¦¬</h2>

        <div class="error-box" th:if="${error}" th:text="${error}"></div>
        <div class="grade-info-box">
            <div class="grade-text">
                íšŒì›ë‹˜ì˜ í˜„ì¬ ë“±ê¸‰ì€
                <span class="badge grade-inline" th:classappend="|bg-${gradeName}|"
                      th:text="${gradeName}">BASIC</span>
                ì…ë‹ˆë‹¤.
            </div>
            <button type="button" class="btn-grade-guide" onclick="openGradeModal()">ë“±ê¸‰ì•ˆë‚´</button>
        </div>

        <form method="post" onsubmit="return validateForm()" th:action="@{/users/me/edit}"
              th:object="${userUpdateRequest}">

            <div class="form-field">
                <label for="name">ì´ë¦„</label>
                <input id="name" required th:field="*{name}" type="text">
            </div>

            <div class="form-field">
                <label for="nickname">ë‹‰ë„¤ì„</label>
                <input id="nickname" required th:field="*{nickname}" type="text">
            </div>

            <div class="form-field">
                <label for="email">ì´ë©”ì¼</label>
                <div class="input-group">
                    <input class="flex-1" id="email" oninput="checkEmailChanged()" required th:field="*{email}"
                           type="email">
                    <button class="btn-verify" disabled id="btnSendCode" onclick="sendVerification()" type="button">
                        ì¸ì¦ë²ˆí˜¸ ì „ì†¡
                    </button>
                </div>

                <div class="mt-2 verification-area" id="verificationArea">
                    <div class="input-group">
                        <input class="flex-1 verify-input" id="verifyCode" placeholder="ì¸ì¦ë²ˆí˜¸ 6ìë¦¬" type="text">
                        <button class="btn-verify" onclick="confirmVerification()" type="button">í™•ì¸</button>
                    </div>
                    <small class="mt-2 verify-message" id="verifyMessage"></small>
                </div>

                <input id="originalEmail" th:value="*{email}" type="hidden">
            </div>

            <div class="form-field">
                <label for="phone">íœ´ëŒ€í° ë²ˆí˜¸</label>
                <input id="phone" placeholder="01000000000" required th:field="*{phone}" type="text">
            </div>

            <div class="form-actions">
                <a class="btn-cancel" href="/users/me">ì·¨ì†Œ</a>
                <button class="submit-btn" type="submit">ìˆ˜ì • ì €ì¥</button>
            </div>

        </form>
    </div>
    <div id="gradeModal" class="modal-overlay" aria-hidden="true">
        <div class="modal-card grade-guide-card">
            <div class="modal-header">
                <h3>íšŒì› ë“±ê¸‰ ì•ˆë‚´</h3>
                <button class="close-btn" type="button" onclick="closeGradeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div th:if="${#lists.isEmpty(allGrades)}">
                    <p class="grade-empty-message">ë“±ê¸‰ ì •ì±… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
                <div th:unless="${#lists.isEmpty(allGrades)}">
                    <div class="grade-list-item" th:each="grade : ${allGrades}">
                        <span class="grade-badge" th:classappend="|bg-${grade.gradeName}|"
                              th:text="${grade.gradeName}">BASIC</span>

                        <div class="grade-desc">
                            <div>í¬ì¸íŠ¸ ì ë¦½ë¥ :
                                <strong th:text="${#numbers.formatInteger(grade.pointAddRate * 100, 0, 'COMMA')} + '%'">1%</strong>
                            </div>
                            <div class="grade-subtext">
                                (ìµœê·¼ 3ê°œì›” ìˆœìˆ˜ ì£¼ë¬¸ <span th:text="${#numbers.formatInteger(grade.pointCutline, 0, 'COMMA')}">0</span>ì› ì´ìƒ)
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grade-hint-box">
                    ğŸ’¡ ë“±ê¸‰ì€ ë§¤ ë¶„ê¸°(1, 4, 7, 10ì›”) 1ì¼ì— ìµœê·¼ 3ê°œì›” ì‹¤ì ì„ ê¸°ì¤€ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <script>
        function openGradeModal() {
            const modal = document.getElementById('gradeModal');
            if (!modal) return;
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeGradeModal() {
            const modal = document.getElementById('gradeModal');
            if (!modal) return;
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        document.addEventListener('click', (event) => {
            const modal = document.getElementById('gradeModal');
            if (!modal || !modal.classList.contains('show')) return;
            if (event.target === modal) {
                closeGradeModal();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeGradeModal();
            }
        });
        const originalEmail = document.getElementById('originalEmail').value;
        let isEmailVerified = true;

        // 1. ì´ë©”ì¼ ë³€ê²½ ê°ì§€
        function checkEmailChanged() {
            const currentEmail = document.getElementById('email').value;
            const btnSendCode = document.getElementById('btnSendCode');
            const verificationArea = document.getElementById('verificationArea');
            const verifyMessage = document.getElementById('verifyMessage');

            if (currentEmail !== originalEmail) {
                // ë³€ê²½ë¨ -> ì¸ì¦ í•„ìš”
                btnSendCode.disabled = false;
                isEmailVerified = false;
                verifyMessage.textContent = '';
            } else {
                // ì›ìƒë³µêµ¬ -> ì¸ì¦ ë¶ˆí•„ìš”
                btnSendCode.disabled = true;
                verificationArea.style.display = 'none';
                isEmailVerified = true;
            }
        }

        // 2. ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ìš”ì²­ (í•¨ìˆ˜ëª…: sendVerification)
        function sendVerification() {
            const email = document.getElementById('email').value;

            if (!email || !email.includes('@')) {
                alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const btn = document.getElementById('btnSendCode');
            btn.innerText = "ì „ì†¡ì¤‘...";
            btn.disabled = true;

            fetch('/email/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'email=' + encodeURIComponent(email)
            })
                .then(function (response) {
                    if (response.ok) {
                        alert('ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        document.getElementById('verificationArea').style.display = 'block';
                        btn.innerText = "ì¬ì „ì†¡";
                        document.getElementById('verifyCode').value = '';
                        document.getElementById('verifyCode').focus();
                        btn.disabled = false; // ì„±ê³µ ì‹œ ë²„íŠ¼ í™œì„±í™”
                    } else {
                        return response.text().then(function (text) {
                            throw new Error(text);
                        });
                    }
                })
                .catch(function (error) {
                    console.error('Error:', error);
                    alert("ë°œì†¡ ì‹¤íŒ¨: " + error.message);

                    // ì—ëŸ¬ ë‚˜ë„ ë²„íŠ¼ì€ ë‹¤ì‹œ ëˆŒëŸ¬ë³¼ ìˆ˜ ìˆê²Œ ë³µêµ¬
                    btn.disabled = false;
                    btn.innerText = "ì¸ì¦ë²ˆí˜¸ ì „ì†¡";
                });
        }

        // 3. ì¸ì¦ë²ˆí˜¸ í™•ì¸ ìš”ì²­ (í•¨ìˆ˜ëª…: confirmVerification)
        function confirmVerification() {
            const email = document.getElementById('email').value;
            const code = document.getElementById('verifyCode').value;
            const msgElem = document.getElementById('verifyMessage');

            if (!code) {
                alert('ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            fetch('/email/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'email=' + encodeURIComponent(email) + '&code=' + encodeURIComponent(code)
            })
                .then(function (response) {
                    if (response.ok) {
                        msgElem.textContent = 'ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                        msgElem.className = 'text-success';
                        isEmailVerified = true;

                        document.getElementById('btnSendCode').disabled = true;
                        document.getElementById('email').readOnly = true;
                    } else {
                        throw new Error('ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(function (error) {
                    msgElem.textContent = error.message;
                    msgElem.className = 'text-danger';
                    isEmailVerified = false;
                });
        }

        // 4. í¼ ì „ì†¡ ê²€ì¦
        function validateForm() {
            const currentEmail = document.getElementById('email').value;

            if (currentEmail !== originalEmail && !isEmailVerified) {
                alert('ë³€ê²½ëœ ì´ë©”ì¼ì— ëŒ€í•œ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return false;
            }
            return true;
        }
    </script>

</div>
</body>
</html>

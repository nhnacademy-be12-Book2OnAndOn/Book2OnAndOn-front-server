<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mypage-layout}"
      th:with="sidebarActive='likes'">

<head>
    <title layout:fragment="title">마이페이지 - 좋아요 도서</title>
    <th:block layout:fragment="extraHead"></th:block>
</head>

<body>
<div class="mypage-content likes-page" layout:fragment="content">
    <div class="dashboard-card page-card">
        <div class="dashboard-header">
            <h2>마음에 담은 책</h2>
            <p class="muted">
                <span th:text="${(user != null && user.nickname != null) ? user.nickname : '회원'}"></span>님이 좋아요를 누른 도서들을 한
                눈에 확인하세요.
            </p>
        </div>

        <div class="liked-empty empty-state" th:if="${books == null or books.isEmpty()}">
            <p>아직 <span th:text="${(user != null && user.nickname != null) ? user.nickname : '회원'}"></span>님의 마음에 담긴 책이 없어요.
            </p>
            <a class="liked-btn-verify empty-action" href="/">마음에 담을 책 찾으러 가기</a>
        </div>

        <div th:unless="${books == null or books.isEmpty()}">
            <div class="liked-grid">
                <div class="liked-card" th:each="item : ${books}">
                    <a class="liked-thumb" th:href="@{/books/{bookId}(bookId=${item.bookInfo.id})}">
                        <img alt="도서 이미지"
                             th:src="${item.bookInfo.imagePath != null ? item.bookInfo.imagePath : '/images/no-image.png'}">
                    </a>
                    <div class="liked-body">
                        <a class="liked-title" th:href="@{/books/{bookId}(bookId=${item.bookInfo.id})}"
                           th:text="${item.bookInfo.title}">도서 제목</a>
                        <p class="liked-authors">
                        <span th:each="author, iterStat : ${item.bookInfo.contributorNames}">
                            <span th:text="${author}">저자</span><span th:if="${!iterStat.last}">, </span>
                        </span>
                        </p>
                        <div class="liked-price">
                        <span class="price-sale"
                              th:text="${#numbers.formatInteger(item.bookInfo.priceSales, 0, 'COMMA') + '원'}">0원</span>
                            <span class="price-origin"
                                  th:if="${item.bookInfo.priceStandard > item.bookInfo.priceSales}"
                                  th:text="${#numbers.formatInteger(item.bookInfo.priceStandard, 0, 'COMMA') + '원'}">0원</span>
                        </div>
                        <div class="liked-meta" th:text="'찜한 날짜 · ' + ${#temporals.format(item.createdAt, 'yyyy-MM-dd')}">
                            2024-01-01
                        </div>
                        <div class="liked-actions">
                            <button type="button"
                                    class="btn-like-action ghost"
                                    th:onclick="|addLikedToCart(${item.bookInfo.id})|">장바구니</button>
                            <button type="button"
                                    class="btn-like-action solid"
                                    th:onclick="|buyLikedNow(${item.bookInfo.id})|">바로 주문</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-nav" th:if="${totalPages > 0}">
                <a aria-label="이전" class="page-btn" th:classappend="${currentPage == 0} ? 'disabled'"
                   th:href="@{/users/me/likes(page=${currentPage - 1})}">이전</a>

                <div class="page-numbers">
                    <a class="page-btn"
                       th:classappend="${pageNum == currentPage} ? 'active'"
                       th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                       th:href="@{/users/me/likes(page=${pageNum})}"
                       th:text="${pageNum + 1}">1</a>
                </div>

                <a aria-label="다음" class="page-btn" th:classappend="${currentPage == totalPages - 1} ? 'disabled'"
                   th:href="@{/users/me/likes(page=${currentPage + 1})}">다음</a>
            </div>
        </div>

        <div id="likedFallback" class="liked-grid" style="display:none;"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fallback = document.getElementById('likedFallback');
            if (!fallback) return;
            if (document.querySelectorAll('.liked-card').length > 0) return;
            let data = {};
            try {
                data = JSON.parse(localStorage.getItem('likedBooks') || '{}');
            } catch (e) {
                data = {};
            }
            const items = Object.values(data).filter(item => item && item.id);
            if (items.length === 0) return;

            const empty = document.querySelector('.liked-empty');
            if (empty) empty.style.display = 'none';
            fallback.style.display = 'grid';

            const formatDate = (value) => {
                if (!value) return '';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return '';
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'liked-card';

                const thumb = document.createElement('a');
                thumb.className = 'liked-thumb';
                thumb.href = `/books/${item.id}`;
                const img = document.createElement('img');
                img.alt = '도서 이미지';
                img.src = item.thumbnail || '/images/no-image.png';
                thumb.appendChild(img);

                const body = document.createElement('div');
                body.className = 'liked-body';

                const titleLink = document.createElement('a');
                titleLink.className = 'liked-title';
                titleLink.href = `/books/${item.id}`;
                titleLink.textContent = item.title || '도서 제목';

                const authors = document.createElement('p');
                authors.className = 'liked-authors';
                authors.textContent = item.authors || '';

                const price = document.createElement('div');
                price.className = 'liked-price';
                const sale = document.createElement('span');
                sale.className = 'price-sale';
                sale.textContent = (item.priceSales || 0).toLocaleString() + '원';
                price.appendChild(sale);
                if (item.priceStandard && item.priceStandard > item.priceSales) {
                    const origin = document.createElement('span');
                    origin.className = 'price-origin';
                    origin.textContent = item.priceStandard.toLocaleString() + '원';
                    price.appendChild(origin);
                }

                const meta = document.createElement('div');
                meta.className = 'liked-meta';
                const likedDate = formatDate(item.likedAt);
                meta.textContent = likedDate ? `찜한 날짜 · ${likedDate}` : '찜한 날짜 · -';

                body.appendChild(titleLink);
                body.appendChild(authors);
                body.appendChild(price);
                body.appendChild(meta);

                // actions
                const actions = document.createElement('div');
                actions.className = 'liked-actions';
                const cartBtn = document.createElement('button');
                cartBtn.className = 'btn-like-action ghost';
                cartBtn.type = 'button';
                cartBtn.textContent = '장바구니';
                cartBtn.onclick = () => addLikedToCart(item.id);
                const buyBtn = document.createElement('button');
                buyBtn.className = 'btn-like-action solid';
                buyBtn.type = 'button';
                buyBtn.textContent = '바로 주문';
                buyBtn.onclick = () => buyLikedNow(item.id);
                actions.appendChild(cartBtn);
                actions.appendChild(buyBtn);

                card.appendChild(thumb);
                card.appendChild(body);
                card.appendChild(actions);
                fallback.appendChild(card);
            });
        });
    </script>
    <script>
        async function addLikedToCart(bookId) {
            if (!bookId) return;
            if (typeof window.addToCart === 'function') {
                return window.addToCart(bookId, 1);
            }
            try {
                await fetch('/cart/user/items', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookId, quantity: 1 })
                });
                alert('장바구니에 담았습니다.');
            } catch (e) {
                alert('장바구니 담기 실패');
            }
        }

        async function buyLikedNow(bookId) {
            if (!bookId) return;
            try {
                const form = document.createElement("form");
                form.method = "POST";
                form.action = "/orders/prepare";

                const hiddenId = document.createElement("input");
                hiddenId.type = "hidden";
                hiddenId.name = "bookItems[0].bookId";
                hiddenId.value = String(bookId);

                const hiddenQty = document.createElement("input");
                hiddenQty.type = "hidden";
                hiddenQty.name = "bookItems[0].quantity";
                hiddenQty.value = "1";

                form.appendChild(hiddenId);
                form.appendChild(hiddenQty);
                document.body.appendChild(form);
                form.submit();
            } catch (e) {
                alert('바로 주문 이동에 실패했습니다.');
            }
        }
    </script>
</div>
</body>
</html>

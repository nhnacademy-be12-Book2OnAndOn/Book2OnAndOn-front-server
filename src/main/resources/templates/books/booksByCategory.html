<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${categoryName} + ' - 도서 목록'">카테고리 도서 목록</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/books-search.css}">
</head>
<body>

<th:block th:replace="~{fragments/layout :: commonHeader(${currentUser}, ${cartCount}, null, null, false)}"></th:block>

<main class="book-section">

    <div class="search-summary">
        <div>
            <span class="search-keyword" th:text="${categoryName}">카테고리명</span>
            <span class="search-count">
                (총 <span th:text="${books.totalElements}">0</span>권)
            </span>
        </div>

        <div>
            <select class="search-sort" onchange="location.href=this.value">
                <option th:value="@{/books/categories/{id}(id=${currentCategoryId}, sort='publishDate,desc', priceRange=${param.priceRange}, ratingRange=${param.ratingRange})}"
                        th:selected="${param.sort == null or param.sort.toString().contains('publishDate')}">최신순</option>
                <option th:value="@{/books/categories/{id}(id=${currentCategoryId}, sort='priceSales,asc', priceRange=${param.priceRange}, ratingRange=${param.ratingRange})}"
                        th:selected="${param.sort != null and param.sort.toString().contains('priceSales,asc')}">낮은가격순</option>
                <option th:value="@{/books/categories/{id}(id=${currentCategoryId}, sort='priceSales,desc', priceRange=${param.priceRange}, ratingRange=${param.ratingRange})}"
                        th:selected="${param.sort != null and param.sort.toString().contains('priceSales,desc')}">높은가격순</option>
            </select>
        </div>
    </div>

    <div th:if="${books.isEmpty()}" class="search-empty">
        <h3>해당 카테고리에 등록된 도서가 없습니다.</h3>
        <a class="btn-green" href="/">홈으로 가기</a>
    </div>

    <div th:unless="${books.isEmpty()}" class="search-layout">
        <aside class="search-filters">
            <div class="filter-card">
                <h4>필터</h4>
                <div class="filter-group">
                    <p class="filter-title">가격대</p>
                    <label class="filter-option">
                        <input type="radio" name="priceRange" value="all" checked>
                        <span>전체</span>
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="priceRange" value="under-15000">
                        <span>15,000원 이하</span>
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="priceRange" value="15000-25000">
                        <span>15,000 - 25,000원</span>
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="priceRange" value="over-25000">
                        <span>25,000원 이상</span>
                    </label>
                </div>
                <div class="filter-divider"></div>
                <div class="filter-group">
                    <p class="filter-title">평점</p>
                    <label class="filter-option">
                        <input type="radio" name="ratingRange" value="4.5">
                        <span>★ 4.5점 이상</span>
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="ratingRange" value="4.0">
                        <span>★ 4점 이상</span>
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="ratingRange" value="3.5">
                        <span>★ 3.5점 이상</span>
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="ratingRange" value="all" checked>
                        <span>★ 전체</span>
                    </label>
                </div>
                <button type="button" class="filter-reset">필터 초기화</button>
            </div>
        </aside>

        <div class="book-grid">
            <div th:each="book : ${books}" class="book-card"
                 th:attr="data-price=${book.priceSales}, data-rating=${book.rating != null ? book.rating : 0}">
                <a class="card-overlay-link" th:href="@{/books/{id}(id=${book.id})}"></a>

                <div class="book-cover">
                    <img th:src="${book.thumbnail != null and book.thumbnail != '' ? book.thumbnail : '/images/no-image.png'}"
                         alt="책 표지"
                         onerror="this.src='https://via.placeholder.com/240x300?text=No+Image'"/>
                </div>

                <div class="book-details">
                    <div class="book-title" th:text="${book.title}">책 제목</div>
                    <div class="book-author"
                         th:text="${book.contributorNames != null ? #strings.listJoin(book.contributorNames, ', ') : ''}">저자</div>

                    <div class="price-row">
                        <span class="book-price"
                              th:text="${#numbers.formatInteger(book.priceSales, 0, 'COMMA') + '원'}">15,000원</span>
                        <span class="book-rating">★ <span th:text="${book.rating}">0.0</span></span>
                    </div>
                </div>

                <button type="button" class="btn-outline-green" onclick="alert('장바구니 기능 구현 필요')">
                    장바구니
                </button>
            </div>
        </div>
    </div>

    <div th:if="${!books.isEmpty()}" class="pagination">
        <a th:if="${books.hasPrevious()}"
           th:href="@{/books/categories/{id}(id=${currentCategoryId}, page=${books.number - 1}, sort=${param.sort}, priceRange=${param.priceRange}, ratingRange=${param.ratingRange})}">&lt;</a>

        <th:block th:each="i : ${#numbers.sequence(0, books.totalPages - 1)}">
            <a th:if="${i >= books.number - 2 and i <= books.number + 2}"
               th:classappend="${i == books.number} ? 'active'"
               th:text="${i + 1}"
               th:href="@{/books/categories/{id}(id=${currentCategoryId}, page=${i}, sort=${param.sort}, priceRange=${param.priceRange}, ratingRange=${param.ratingRange})}">1</a>
        </th:block>

        <a th:if="${books.hasNext()}"
           th:href="@{/books/categories/{id}(id=${currentCategoryId}, page=${books.number + 1}, sort=${param.sort}, priceRange=${param.priceRange}, ratingRange=${param.ratingRange})}">&gt;</a>
    </div>

</main>

<th:block th:replace="~{fragments/layout :: commonFooter}"></th:block>
<script th:src="@{/js/book-filters.js}"></script>

</body>
</html>

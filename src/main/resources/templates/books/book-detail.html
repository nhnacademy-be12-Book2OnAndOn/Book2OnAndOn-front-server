<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${bookDetail.title} + ' - Book2OnAndOn'">ë„ì„œ ìƒì„¸ - Book2OnAndOn</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/book-detail.css}">
</head>
<body>
<th:block th:replace="~{fragments/layout :: commonHeader(${user} ?: ${session.user}, ${cartCount}, null, null, false)}"></th:block>

<main class="book-detail-page" th:with="currentUser=${user} ?: ${session.user}">
    <div class="container" th:object="${bookDetail}">

        <section class="product-wrapper">
            <div class="product-gallery">
                <div class="main-image">
                    <img id="mainImg"
                         th:if="${bookDetail.images != null and !bookDetail.images.isEmpty()}"
                         th:src="${bookDetail.images[0].url}"
                         alt="ë„ì„œ ë©”ì¸ ì´ë¯¸ì§€">
                    <div class="thumb-fallback big"
                         th:unless="${bookDetail.images != null and !bookDetail.images.isEmpty()}">
                        ì´ë¯¸ì§€ ì¤€ë¹„ì¤‘
                    </div>
                </div>
                <div class="thumbnail-list" th:if="${bookDetail.images != null and bookDetail.images.size() > 1}">
                    <div class="thumb-item" th:each="img : ${bookDetail.images}"
                         onclick="changeMainImage(this.querySelector('img').src)">
                        <img th:src="${img.url}" alt="ì¸ë„¤ì¼">
                    </div>
                </div>
            </div>

            <div class="product-info">
                <div class="breadcrumb" th:if="${bookDetail.categories != null}">
                    <span th:each="cat, iter : ${bookDetail.categories}">
                        <span th:text="${cat.name}">ì¹´í…Œê³ ë¦¬</span>
                        <span th:if="${!iter.last}"> &gt; </span>
                    </span>
                </div>

                <div class="product-header">
                    <div class="title-wrap">
                        <span class="badge-status" th:if="${bookDetail.status.name() == 'SOLD_OUT'}">í’ˆì ˆ</span>
                        <span class="badge-status sale" th:if="${bookDetail.status.name() == 'ON_SALE'}">íŒë§¤ì¤‘</span>
                        <h1 class="product-title">
                            <span th:text="${bookDetail.title}">ë„ì„œ ì œëª©</span>
                            <span class="vol" th:if="${bookDetail.volume}" th:text="' - ' + ${bookDetail.volume}">ê¶Œ</span>
                        </h1>
                    </div>

                    <div class="author-publisher">
                        <span class="author" th:text="${bookDetail.contributorName} ?: 'ì €ì ë¯¸ìƒ'">ì €ìëª…</span>
                        <span class="divider">|</span>
                        <span class="publisher" th:each="pub : ${bookDetail.publishers}" th:text="${pub.name} + ' '">ì¶œíŒì‚¬</span>
                        <span class="divider">|</span>
                        <span class="date" th:text="${#temporals.format(bookDetail.publishDate, 'yyyyë…„ MMì›” ddì¼')}">2024-01-01</span>
                        <span class="divider" th:if="${bookDetail.categories != null and !bookDetail.categories.isEmpty()}">|</span>
                        <span class="category-chip"
                              th:if="${bookDetail.categories != null and !bookDetail.categories.isEmpty()}"
                              th:text="${#strings.listJoin(bookDetail.categories.![name], ' > ')}">ì¹´í…Œê³ ë¦¬ ê²½ë¡œ</span>
                    </div>

                    <div class="rating-summary">
                        <span class="stars">â˜…</span>
                        <span class="score" th:text="${bookDetail.rating}">4.8</span>
                        <span class="count" th:text="'(' + ${bookDetail.reviewCount} + 'ê°œì˜ ë¦¬ë·°)'">(120ê°œì˜ ë¦¬ë·°)</span>
                    </div>
                    <div class="admin-actions"
                         th:if="${currentUser != null and #strings.contains(currentUser.role, 'ADMIN')}">
                        <a class="btn admin-edit" th:href="@{/admin/books/{id}/edit(id=${bookDetail.id})}">ë„ì„œ ìˆ˜ì •</a>
                    </div>
                </div>

                <hr class="soft-divider">

                <div class="price-area">
                    <div class="price-row">
                        <span class="label">íŒë§¤ê°€</span>
                        <span class="sale-price" th:text="${#numbers.formatInteger(bookDetail.priceSales, 0, 'COMMA')} + 'ì›'">19,800ì›</span>
                        <span class="discount-rate"
                              th:with="discount=${(bookDetail.priceStandard - bookDetail.priceSales) * 100.0 / bookDetail.priceStandard}"
                              th:text="${#numbers.formatInteger(discount, 0, 'COMMA')} + '%'">10%</span>
                    </div>
                    <div class="price-row small">
                        <span class="label">ì •ê°€</span>
                        <span class="original-price" th:text="${#numbers.formatInteger(bookDetail.priceStandard, 0, 'COMMA')} + 'ì›'">22,000ì›</span>
                    </div>
                </div>

                <div class="meta-info-box">
                    <div class="row">
                        <span class="th">ë°°ì†¡ë¹„</span>
                        <span class="td">3,000ì› (3ë§Œì› ì´ìƒ ë¬´ë£Œ)</span>
                    </div>
                    <div class="row" th:if="${bookDetail.isWrapped}">
                        <span class="th">ì„ ë¬¼í¬ì¥</span>
                        <span class="td">ê°€ëŠ¥</span>
                    </div>
                </div>

                <div class="tags-area" th:if="${bookDetail.tags != null}">
                    <span class="tag-chip" th:each="tag : ${bookDetail.tags}" th:text="'#' + ${tag.name}">#íƒœê·¸</span>
                </div>

                <div class="purchase-actions">
                    <div class="coupon-download">
                        <div class="coupon-text">
                            <p class="label">ì¿ í°</p>
                            <p class="muted">ì ìš© ê°€ëŠ¥í•œ ì¿ í°ì„ ë°›ì•„ë³´ì„¸ìš”.</p>
                        </div>

                        <button class="btn ghost"
                                type="button"
                                onclick="openCouponModal()"> ì¿ í° ë‹¤ìš´ë¡œë“œ <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>

                    <div class="purchase-row">
                        <div class="quantity-control">
                            <button type="button" onclick="adjustQuantity(-1)">-</button>
                            <input type="text" id="quantity" value="1" readonly>
                            <button type="button" onclick="adjustQuantity(1)">+</button>
                        </div>
                        <div class="total-price-preview">
                            ì´ ìƒí’ˆê¸ˆì•¡ <strong id="totalPrice" th:text="${#numbers.formatInteger(bookDetail.priceSales, 0, 'COMMA')}">19,800</strong>ì›
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="like-btn large"
                            th:classappend="${bookDetail.likedByCurrentUser} ? 'active' : ''"
                            th:attr="data-book-id=${bookDetail.id}, data-book-title=${bookDetail.title}, data-book-authors=${bookDetail.contributorName}, data-book-thumb=${(bookDetail.images != null and !bookDetail.images.isEmpty()) ? bookDetail.images[0].url : ''}, data-book-price-sales=${bookDetail.priceSales}, data-book-price-standard=${bookDetail.priceStandard}"
                            th:onclick="'toggleLike(this, ' + ${bookDetail.id} + ')'">
                        <span class="heart-icon"></span>
                        <span class="like-count" th:text="${bookDetail.likeCount}">0</span>
                    </button>
                    <button type="button" class="btn ghost"
                            th:onclick="|addToCart(${bookDetail.id}, parseInt(document.getElementById('quantity')?.value || '1'))|">ì¥ë°”êµ¬ë‹ˆ</button>
                    <button type="button" class="btn primary fill">ë°”ë¡œêµ¬ë§¤</button>
                </div>

            </div> </section>

        <section class="detail-content-wrapper">
            <div class="tab-nav" id="detailTabs">
                <button class="tab-item active" data-tab="info" type="button">ë„ì„œ ì •ë³´</button>
                <button class="tab-item" data-tab="intro" type="button">ì±… ì†Œê°œ</button>
                <button class="tab-item" data-tab="toc" type="button" th:if="${bookDetail.chapter != null}">ëª©ì°¨</button>
                <button class="tab-item" data-tab="reviews" type="button">ë¦¬ë·° (<span th:text="${bookDetail.reviewCount}">0</span>)</button>
            </div>

            <div id="recentMeta"
                 th:data-id="${bookDetail.id}"
                 th:data-title="${bookDetail.title}"
                 th:data-author="${bookDetail.contributorName}"
                 th:data-thumb="${(bookDetail.images != null and !bookDetail.images.isEmpty()) ? bookDetail.images[0].url : ''}"
                 style="display:none;"></div>

            <div id="info" class="content-block tab-panel active">
                <h3>ë„ì„œ ì •ë³´</h3>
                <div class="meta-info-box">
                    <div class="row">
                        <span class="th">ISBN</span>
                        <span class="td" th:text="${bookDetail.isbn}">97911000000</span>
                    </div>
                    <div class="row">
                        <span class="th">ë°œí–‰ì¼</span>
                        <span class="td" th:text="${#temporals.format(bookDetail.publishDate, 'yyyyë…„ MMì›” ddì¼')}">2024ë…„ 01ì›” 01ì¼</span>
                    </div>
                    <div class="row" th:if="${bookDetail.publishers != null and !bookDetail.publishers.isEmpty()}">
                        <span class="th">ì¶œíŒì‚¬</span>
                        <span class="td" th:text="${#strings.listJoin(bookDetail.publishers.![name], ', ')}">ì¶œíŒì‚¬ëª…</span>
                    </div>
                    <div class="row" th:if="${bookDetail.categories != null and !bookDetail.categories.isEmpty()}">
                        <span class="th">ë¶„ë¥˜</span>
                        <span class="td" th:text="${#strings.listJoin(bookDetail.categories.![name], ' > ')}">ì¹´í…Œê³ ë¦¬ ê²½ë¡œ</span>
                    </div>
                    <div class="row" th:if="${bookDetail.stockCount != null}">
                        <span class="th">ì¬ê³ </span>
                        <span class="td" th:text="${bookDetail.stockCount > 0 ? bookDetail.stockCount + 'ê¶Œ' : 'í’ˆì ˆ'}">ì¬ê³  ì •ë³´</span>
                    </div>
                </div>
            </div>

            <div id="intro" class="content-block tab-panel">
                <h3>ì±… ì†Œê°œ</h3>
                <div class="description-body" th:utext="${bookDetail.descriptionHtml}">
                </div>
            </div>

            <div id="toc" class="content-block tab-panel" th:if="${bookDetail.chapter != null}">
                <h3>ëª©ì°¨</h3>
                <div class="toc-body" th:utext="${#strings.replace(bookDetail.chapter, '
', '<br>')}">
                </div>
            </div>

            <div id="reviews" class="content-block tab-panel">
                <div class="review-header">
                    <h3>ê³ ê° ë¦¬ë·°</h3>
                    <a class="btn secondary sm" href="#reviewForm">ë¦¬ë·° ì‘ì„±</a>
                </div>

                <div class="review-summary-card" th:data-rating="${bookDetail.rating}">
                    <div class="review-score-block">
                        <div class="score-value" th:text="${bookDetail.rating}">4.8</div>
                        <div class="score-stars" aria-label="í‰ê·  í‰ì ">
                            <span class="star filled">â˜…</span>
                            <span class="star filled">â˜…</span>
                            <span class="star filled">â˜…</span>
                            <span class="star filled">â˜…</span>
                            <span class="star">â˜…</span>
                        </div>
                        <div class="score-count" th:text="${bookDetail.reviewCount} + 'ê°œ ë¦¬ë·°'">1,247ê°œ ë¦¬ë·°</div>
                    </div>
                    <div class="review-bars">
                        <div class="review-bar-row" th:each="star : ${#numbers.sequence(5,1,-1)}" th:data-star="${star}">
                            <span class="label" th:text="${star} + 'ì '">5ì </span>
                            <div class="review-bar">
                                <span class="fill" style="width:0%"></span>
                            </div>
                            <span class="percent">0%</span>
                        </div>
                    </div>
                </div>

                <div class="review-form-card" id="reviewForm">
                    <div class="form-card-inner" th:if="${currentUser != null}">
                        <div class="form-card-head">
                            <div>
                                <p class="eyebrow">ë¦¬ë·° ì‘ì„±</p>
                                <h4>ë‹¹ì‹ ì˜ í•œ ì¤„ì´ ëˆ„êµ°ê°€ì˜ ì„ íƒì´ ë©ë‹ˆë‹¤</h4>
                            </div>
                        </div>
                        <form th:action="@{'/api/books/' + ${bookDetail.id} + '/reviews'}" method="post" enctype="multipart/form-data">
                            <div class="form-grid two-col">
                                <div class="form-field">
                                    <label for="reviewTitle">ì œëª©</label>
                                    <input id="reviewTitle" name="title" type="text" placeholder="ë¦¬ë·° ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                                </div>
                                <div class="form-field">
                                    <label for="reviewScore">ë³„ì </label>
                                    <div class="star-rate" id="starRate" aria-label="ë³„ì  ì„ íƒ" role="radiogroup">
                                        <input type="hidden" name="score" id="reviewScore" required>
                                        <span class="star" data-value="1">â˜…</span>
                                        <span class="star" data-value="2">â˜…</span>
                                        <span class="star" data-value="3">â˜…</span>
                                        <span class="star" data-value="4">â˜…</span>
                                        <span class="star" data-value="5">â˜…</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="reviewContent">ë‚´ìš©</label>
                                <textarea id="reviewContent" name="content" rows="4" placeholder="ë„ì„œì— ëŒ€í•œ ì†”ì§í•œ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš” (10~500ì)" required></textarea>
                            </div>
                            <div class="form-field">
                                <label for="reviewImages">ì´ë¯¸ì§€ (ì„ íƒ)</label>
                                <input id="reviewImages" type="file" name="images" accept="image/*" multiple>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn primary sm">ë“±ë¡</button>
                            </div>
                        </form>
                    </div>
                    <div class="form-card-inner muted" th:if="${currentUser == null}">
                        <div class="form-card-head">
                            <div>
                                <p class="eyebrow">ë¡œê·¸ì¸ í•„ìš”</p>
                                <h4>ë¦¬ë·° ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤</h4>
                            </div>
                        </div>
                        <p style="margin: 0 0 1rem;">ì¢‹ì•„í•œ ì±…ì— ëŒ€í•´ ì´ì•¼ê¸°ë¥¼ ë‚¨ê¸°ê³  ì‹¶ë‹¤ë©´ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.</p>
                        <a class="btn ghost" href="/login">ë¡œê·¸ì¸í•˜ê¸°</a>
                    </div>
                </div>

                <div class="review-list">
                    <div class="review-item" th:each="review : ${bookDetail.reviews}" th:data-score="${review.score}">
                        <div class="review-meta">
                            <span class="reviewer" th:text="${review.writerName} ?: 'ìµëª…'">ì‚¬ìš©ì</span>
                            <span class="stars">
                                <span th:each="i : ${#numbers.sequence(1,5)}"
                                      th:text="${i <= review.score} ? 'â˜…' : 'â˜†'">â˜…</span>
                            </span>
                            <span class="date" th:text="${#temporals.format(review.writeDate, 'yyyy.MM.dd')}">2024.01.01</span>
                        </div>
                        <p class="review-content" th:text="${review.content}">ë¦¬ë·° ë‚´ìš©ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>
                        <div class="review-helpful">
                            <button type="button" class="btn ghost sm" disabled>ë„ì›€ë¨ <span th:text="${review.helpfulCount} ?: 0">0</span></button>
                        </div>
                    </div>
                    <div class="empty-review" th:if="${bookDetail.reviews == null or bookDetail.reviews.isEmpty()}">
                        <p>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
                    </div>
                </div>
            </div>
        </section>

    </div>
</main>

<th:block th:replace="~{fragments/layout :: commonFooter}"></th:block>
<script th:inline="javascript">
    /*<![CDATA[*/
    const unitPrice = [[${bookDetail.priceSales}]];
    const bookId = [[${bookDetail.id}]];
    const categoryIds = [[${bookDetail.categories != null ? bookDetail.categories.![id] : {}}]];

    const recentMetaEl = document.getElementById('recentMeta');
    const recentBook = (function () {
        if (!recentMetaEl) return {};
        const id = Number(recentMetaEl.dataset.id) || null;
        const title = recentMetaEl.dataset.title || null;
        const authorRaw = recentMetaEl.dataset.author || '';
        const contributors = authorRaw
            ? authorRaw.split(',').map(s => s.trim()).filter(Boolean)
            : [];
        const thumb = recentMetaEl.dataset.thumb || null;
        return { id, title, contributorNames: contributors, thumbnail: thumb };
    })();

    function getCookie(name) {
        const match = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([$?*|{}()[\]\\/+^])/g, '\\$1') + '=([^;]*)'));
        return match ? decodeURIComponent(match[1]) : null;
    }

    function setCookie(name, value, days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = `${name}=${encodeURIComponent(value)}; path=/; expires=${date.toUTCString()}`;
    }

    // ë¹„ë¡œê·¸ì¸ ì‹œì—ë„ guest idë¥¼ ë‚¨ê²¨ë‘ì–´ ë¡œê·¸ì¸ ì‹œ ë³‘í•©ë  ìˆ˜ ìˆê²Œ í•¨
    if (window.ensureGuestId) {
        window.ensureGuestId();
    }

    function changeMainImage(src) {
        document.getElementById('mainImg').src = src;
    }

    function adjustQuantity(delta) {
        const input = document.getElementById('quantity');
        let newVal = parseInt(input.value) + delta;
        if (newVal < 1) newVal = 1;
        // ìµœëŒ€ ì¬ê³  ì²´í¬ (í•„ìš”ì‹œ)
        // if (newVal > [[${bookDetail.stockCount}]]) newVal = [[${bookDetail.stockCount}]];

        input.value = newVal;
        updateTotalPrice(newVal);
    }

    function updateTotalPrice(qty) {
        const total = unitPrice * qty;
        document.getElementById('totalPrice').innerText = total.toLocaleString();
    }

    function saveRecentLocal(book) {
        if (!book || book.id == null) return;
        try {
            const raw = localStorage.getItem('recentBooks');
            const list = raw ? JSON.parse(raw) : [];
            const filtered = Array.isArray(list) ? list.filter(b => b && b.id !== book.id) : [];
            filtered.unshift(book);
            const sliced = filtered.slice(0, 10);
            localStorage.setItem('recentBooks', JSON.stringify(sliced));
        } catch (e) {
            // ignore storage errors
        }
    }

    saveRecentLocal(recentBook);
    // 2. ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜
    function openCouponModal() {
        loadCoupons();
        const modal = document.getElementById('couponModal');
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    }

    function closeCouponModal() {
        const modal = document.getElementById('couponModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('couponModal');
        if(modal) {
            modal.addEventListener('click', (e) => { if (e.target === modal) closeCouponModal(); });
        }
    });

    async function loadCoupons() {
        const loadingEl = document.getElementById('couponLoading');
        const listContainer = document.getElementById('couponListContainer');
        const emptyMsgEl = document.getElementById('couponEmptyMsg');

        loadingEl.style.display = 'block';
        listContainer.innerHTML = '';
        emptyMsgEl.style.display = 'none';

        try {
            const params = new URLSearchParams();
            params.append('bookId', bookId);
            if (Array.isArray(categoryIds)) {
                categoryIds.forEach(id => params.append('categoryIds', id));
            }

            const response = await fetch(`/api/coupons/issuable?${params.toString()}`);
            if (!response.ok) throw new Error("ì¿ í° ì¡°íšŒ ì‹¤íŒ¨");

            const coupons = await response.json();

            // [ìˆ˜ì • í¬ì¸íŠ¸ 1] ì´ë¯¸ ë°œê¸‰ë°›ì€ ì¿ í°ì„ ì•„ì˜ˆ ì•ˆ ë³´ì´ê²Œ í•˜ë ¤ë©´ ì—¬ê¸°ì„œ í•„í„°ë§
            // const visibleCoupons = coupons.filter(c => !c.isIssued);
            // ì—¬ê¸°ì„œëŠ” 'ë°œê¸‰ ì™„ë£Œ' í‘œì‹œë¥¼ ìœ„í•´ ê·¸ëŒ€ë¡œ ë‹¤ ë³´ì—¬ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.

            if (!coupons || coupons.length === 0) {
                emptyMsgEl.style.display = 'block';
            } else {
                coupons.forEach(coupon => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'coupon-card';

                    // í• ì¸ ê°’ í¬ë§·íŒ…
                    let displayVal = coupon.discountValue;
                    let displayUnit = '';

                    if (coupon.discountType === 'PERCENT' || coupon.discountType === 'RATE') {
                        displayUnit = '%';
                    } else {
                        displayUnit = 'ì›';
                        displayVal = displayVal.toLocaleString();
                    }

                    // ì¡°ê±´ í…ìŠ¤íŠ¸
                    let conditionText = 'ì¡°ê±´ ì—†ìŒ';
                    if (coupon.minPrice && coupon.minPrice > 0) {
                        conditionText = `${coupon.minPrice.toLocaleString()}ì› ì´ìƒ êµ¬ë§¤ ì‹œ ì‚¬ìš© ê°€ëŠ¥`;
                    }

                    // ê¸°ê°„ í…ìŠ¤íŠ¸
                    let dateText = '';
                    if (coupon.endDate) {
                        dateText = `~ ${coupon.endDate} ê¹Œì§€`;
                    } else if (coupon.durationDays) {
                        dateText = `ë°œê¸‰ í›„ ${coupon.durationDays}ì¼ê°„ ìœ íš¨`;
                    } else {
                        dateText = 'ê¸°ê°„ ì œí•œ ì—†ìŒ';
                    }

                    // [í•µì‹¬ ìˆ˜ì •] isIssued ê°’ì— ë”°ë¼ ë²„íŠ¼ ìƒíƒœ ê²°ì •
                    let btnDisabled = '';
                    let btnText = 'ë‹¤ìš´ë¡œë“œ';
                    let btnClass = 'btn-download';

                    if (coupon.isIssued === true) {
                        btnDisabled = 'disabled';
                        btnText = 'ë°œê¸‰ ì™„ë£Œ';
                        btnClass += ' completed'; // íšŒìƒ‰ ìŠ¤íƒ€ì¼ ì ìš©ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
                    }

                    cardDiv.innerHTML = `
                        <div class="card-upper">
                            <div class="discount-display">
                                <span class="discount-val">${displayVal}</span>
                                <span class="discount-unit">${displayUnit}</span>
                            </div>
                            <div class="coupon-info">
                                <div class="coupon-name">${coupon.couponName}</div>
                                <div class="coupon-condition">${conditionText}</div>
                            </div>
                        </div>
                        <div class="card-bottom">
                            <span class="date-info">ğŸ“… ${dateText}</span>
                            <button type="button" class="${btnClass}"
                                    onclick="issueCoupon(${coupon.couponId}, this)"
                                    ${btnDisabled}>
                                ${btnText}
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(cardDiv);
                });
            }
        } catch (error) {
            console.error(error);
            listContainer.innerHTML = `<div class="text-danger text-center p-3">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>${error.message}</div>`;
        } finally {
            loadingEl.style.display = 'none';
        }
    }

    // 4. ì¿ í° ë°œê¸‰ (ë¡œê·¸ì¸ ë¦¬ë‹¤ì´ë ‰íŠ¸ í¬í•¨)
    async function issueCoupon(couponId, btn) {
        if (btn) {
            btn.disabled = true;
            btn.innerText = 'ì²˜ë¦¬ì¤‘...';
        }

        try {
            const response = await fetch(`/api/coupons/${couponId}/issue`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            // [í•µì‹¬] 401 ì—ëŸ¬(ë¹„ë¡œê·¸ì¸) ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ ì´ë™
            if (response.status === 401) {
                if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    window.location.href = '/login';
                } else {
                    if(btn) {
                        btn.disabled = false;
                        btn.innerText = 'ë‹¤ìš´ë¡œë“œ';
                    }
                }
                return;
            }

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'ë°œê¸‰ ì‹¤íŒ¨');
            }

            alert('ì¿ í°ì´ ì •ìƒì ìœ¼ë¡œ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.');

            if (btn) {
                btn.innerText = 'ë°œê¸‰ ì™„ë£Œ';
                btn.classList.add('completed'); // íšŒìƒ‰ ìŠ¤íƒ€ì¼ ì ìš©
            }

        } catch (error) {
            alert(error.message);
            if (btn) {
                btn.disabled = false;
                btn.innerText = 'ë‹¤ìš´ë¡œë“œ';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const reviewItems = document.querySelectorAll('#reviews .review-item');
        const reviewBars = document.querySelectorAll('#reviews .review-bar-row');
        const summaryCard = document.querySelector('#reviews .review-summary-card');
        const tabs = document.querySelectorAll('#detailTabs .tab-item');
        const panels = document.querySelectorAll('.tab-panel');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                tabs.forEach(t => t.classList.toggle('active', t === tab));
                panels.forEach(panel => panel.classList.toggle('active', panel.id === target));
            });
        });

        if (summaryCard) {
            const ratingValue = Number(summaryCard.dataset.rating) || 0;
            const filled = Math.max(0, Math.min(5, Math.round(ratingValue)));
            const stars = summaryCard.querySelectorAll('.score-stars .star');
            stars.forEach((star, index) => {
                if (index < filled) {
                    star.classList.add('filled');
                } else {
                    star.classList.remove('filled');
                }
            });
        }
        if (reviewBars.length === 0) return;
        const counts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
        reviewItems.forEach(item => {
            const score = Math.round(Number(item.dataset.score));
            if (score >= 1 && score <= 5) {
                counts[score] += 1;
            }
        });
        const total = Object.values(counts).reduce((sum, value) => sum + value, 0);
        reviewBars.forEach(row => {
            const star = Number(row.dataset.star);
            const percent = total > 0 ? Math.round((counts[star] / total) * 100) : 0;
            const fill = row.querySelector('.fill');
            const label = row.querySelector('.percent');
            if (fill) fill.style.width = `${percent}%`;
            if (label) label.textContent = `${percent}%`;
        });

        // ë³„ì  ë“œë˜ê·¸/í˜¸ë²„ ì„ íƒ
        const starContainer = document.getElementById('starRate');
        const starInput = document.getElementById('reviewScore');
        if (starContainer && starInput) {
            const stars = Array.from(starContainer.querySelectorAll('.star'));
            let current = Number(starInput.value) || 0;

            const render = (val) => {
                stars.forEach(star => {
                    const v = Number(star.dataset.value);
                    star.classList.toggle('active', v <= val);
                });
            };

            const handleSelect = (val) => {
                current = val;
                starInput.value = val;
                render(val);
            };

            stars.forEach(star => {
                star.addEventListener('mouseenter', () => render(Number(star.dataset.value)));
                star.addEventListener('mouseleave', () => render(current));
                star.addEventListener('click', () => handleSelect(Number(star.dataset.value)));
            });

            // ë“œë˜ê·¸ë¡œ ë³„ì  ì±„ìš°ê¸°
            let dragging = false;
            starContainer.addEventListener('mousedown', (e) => {
                dragging = true;
                const target = e.target.closest('.star');
                if (target) handleSelect(Number(target.dataset.value));
            });
            window.addEventListener('mouseup', () => dragging = false);
            starContainer.addEventListener('mousemove', (e) => {
                if (!dragging) return;
                const target = e.target.closest('.star');
                if (target) handleSelect(Number(target.dataset.value));
            });

            render(current);
        }
    });
    /*]]>*/
</script>
<div id="couponModal" class="modal-overlay">
    <div class="modal-content-custom">
        <div class="modal-header-custom">
            <h3>ì¿ í° ë‹¤ìš´ë¡œë“œ</h3>
            <button type="button" class="close-modal-btn" onclick="closeCouponModal()">Ã—</button>
        </div>

        <div class="modal-body-custom">
            <div id="couponLoading" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-success" role="status"></div>
                <p class="mt-2 text-muted">ì¡°íšŒ ì¤‘...</p>
            </div>

            <div id="couponListContainer" class="coupon-list-wrapper">
            </div>

            <div id="couponEmptyMsg" class="text-center py-5" style="display: none;">
                <p style="font-size: 2rem;">ğŸ“­</p>
                <p>ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <div class="modal-footer-custom">
            <button type="button" class="btn btn-secondary" onclick="closeCouponModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>
</body>
</html>
